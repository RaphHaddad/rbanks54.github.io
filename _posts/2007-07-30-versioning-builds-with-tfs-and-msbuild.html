---
layout: post
title: Versioning Builds with TFS and MSBuild
date: '2007-07-30T22:25:00.002+10:00'
author: Richard Banks
tags:
- readify
- TFS
- development
modified_time: '2010-07-30T09:33:03.415+10:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-6584498969856413690
blogger_orig_url: http://www.richard-banks.org/2007/07/versioning-builds-with-tfs-and-msbuild.html
---

<p>UPDATE: A post showing <a href="http://www.richard-banks.org/2010/07/how-to-versioning-builds-with-tfs-2010.html">how this works in TFS 2010</a> is now available</p><p>In this post I want to show you one way to add a version file to a web site project and a version number to a business layer DLL based on the latest changeset number for your code in TFS, all through a single MSBuild script.</p><p>If you want to do this in your own projects you'll need to make sure you have MSBuild (part of Visual Studio 2005) and that you have also obtained the latest <a href="http://msbuildtasks.tigris.org/" target="_blank">MSBuild Community Tasks</a>.</p><p>Out of the box MSBuild includes enough tasks to cover the needs of building applications within Visual Studio 2005 but in order to really make it sing we need to extend its functionality through the use of custom tasks.  Now if we wanted we could write our own tasks, but why reinvent the wheel?  The <a href="http://msbuildtasks.tigris.org/">MSBuild Community Tasks</a> are a great set of tasks and provide all the extra features we need to achieve our goal.  Oh, by the way, the web site for the tasks is pretty much a placeholder - all the real information on the tasks is available in a CHM file that comes with the install kit. </p><p>Now, what we want our build script to do is the following:</p><p>1. Get the latest Changeset number from TFS.  We'll use this as the revision number.  We want to end up with an assembly version number like 1.2.3.### with ### being the changeset number.</p><p>2. Update all the AssemblyInfo files with the desired version number.</p><p>3. Compile the application.</p><p>4. Add a version.txt file to our web site so that we can see what build version the web site is.</p><p> </p><p>OK, let's get started!</p><h4><a>Script Header</a></h4><p><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">&lt;</span><span style="COLOR: rgb(163,21,21)">Project</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">DefaultTargets</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">Build</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">xmlns</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">http://schemas.microsoft.com/developer/msbuild/2003</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />   &lt;</span><span style="COLOR: rgb(163,21,21)">Import</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Project</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets</span>"<span style="COLOR: rgb(0,0,255)">/&gt;<br /></span></pre><br /><p>This defines the project, set’s the default target to "Build" and imports the community task definitions, ready for later use.<br /><h4><a>Properties</a></h4><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">   &lt;</span><span style="COLOR: rgb(163,21,21)">PropertyGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Major</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Condition</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">'$(Major)'==''</span>"<span style="COLOR: rgb(0,0,255)">&gt;</span>1<span style="COLOR: rgb(0,0,255)">&lt;/</span><span style="COLOR: rgb(163,21,21)">Major</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Minor</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Condition</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">'$(Minor)'==''</span>"<span style="COLOR: rgb(0,0,255)">&gt;</span>0<span style="COLOR: rgb(0,0,255)">&lt;/</span><span style="COLOR: rgb(163,21,21)">Minor</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Build</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Condition</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">'$(Build)'==''</span>"<span style="COLOR: rgb(0,0,255)">&gt;</span>0<span style="COLOR: rgb(0,0,255)">&lt;/</span><span style="COLOR: rgb(163,21,21)">Build</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Revision</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Condition</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">'$(Revision)'==''</span>"<span style="COLOR: rgb(0,0,255)">&gt;</span>0<span style="COLOR: rgb(0,0,255)">&lt;/</span><span style="COLOR: rgb(163,21,21)">Revision</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Configuration</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Condition</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">'$(Configuration)'==''</span>"<span style="COLOR: rgb(0,0,255)">&gt;</span>Debug<span style="COLOR: rgb(0,0,255)">&lt;/</span><span style="COLOR: rgb(163,21,21)">Configuration</span><span style="COLOR: rgb(0,0,255)">&gt;<br />  &lt;/</span><span style="COLOR: rgb(163,21,21)">PropertyGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>Here we define the various properties we will use in the project.  We're setting up 4 properties to hold the 4 parts of the version number, and we're also creating a property for the build configuration we wish to use (ie Debug or Release).  By default our version number will be 1.0.0.0 and we'll be building the application in Debug mode<br /><p>Properties in MSBuild are referenced using the <b><i>$(PropertyName)</i></b> syntax and any properties not explicitly defined will be evaluated as empty strings.<br /><p>The Condition clause is used to determine if a property has a supplied value and if it doesn’t then we supply a default value.<br /><p>When MSBuild gets called from the command line the value of the /p: switch is parsed to populate the property values with initial values.<br /><h4><a>Item Groups</a></h4><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">    &lt;</span><span style="COLOR: rgb(163,21,21)">ItemGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">ProjectsToBuild</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Include</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">BusinessLayer.csproj</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />    &lt;</span><span style="COLOR: rgb(163,21,21)">ProjectsToBuild</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Include</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">MyWebSite.sln</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />  &lt;/</span><span style="COLOR: rgb(163,21,21)">ItemGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br />  &lt;</span><span style="COLOR: rgb(163,21,21)">ItemGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br />    &lt;</span><span style="COLOR: rgb(163,21,21)">AssemblyInfoFiles</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Include</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(MSBuildProjectDirectory)\**\assemblyinfo.cs</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />  &lt;/</span><span style="COLOR: rgb(163,21,21)">ItemGroup</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>We now define Item Groups.  Item Groups are conceptually the same as collections and contain "items" that the various MSBuild tasks can act upon.  The <i>Include</i> clause allows us to add multiple items to the collection in one go.<br /><p>Here we're creating a collection of projects to build - the business layer and the web site itself.<br /><p>We also create a collection of assemblyinfo.cs files.  The double asterix (<b><i>**</i></b>) on the AssemblyInfoFiles element ensures that all subdirectories are recursively searched for the assemblyinfo.cs files, regardless of their depth.<br /><p>ItemGroups are referenced in MSBuild using the <b><i>@(ItemGroup)</i></b> syntax.<br /><h4><a>Main Build Target</a></h4><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">    &lt;</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Name</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">Build</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">DependsOnTargets</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">SetVersionInfo;SetWebVersionInfo</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">MSBuild</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Projects</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">@(ProjectsToBuild)</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Properties</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">Configuration=$(Configuration)</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />    &lt;/</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>Targets are the items that define the work MSBuild will perform. Here we define the default target for the build.<br /><p>Hang on. Why are we building now - we haven't done anything about the version number...  Notice the DependsOnTargets property?  MSBuild will ensure that any targets listed there are evaluated and processed before this target gets actioned.<br /><p>This means we will actually process SetVersionInfo before we recursively call MSBuild to compile the business layer and the web site.<br /><p>When the MSBuild task gets called it will process the projects in the order they exist in the <i>ProjectsToBuild</i> item group.Note that we are passing through the configuration we to build. <br /><h4><a>SetVersionInfo Target</a></h4><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">    &lt;</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Name</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">SetVersionInfo</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">DependsOnTargets</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">GetTFSVersion</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Attrib</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Files</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">@(AssemblyInfoFiles)</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Normal</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">true</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">FileUpdate</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Files</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">@(AssemblyInfoFiles)</span>"<br /><span style="COLOR: rgb(0,0,255)">                                </span><span style="COLOR: rgb(255,0,0)">Regex</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">AssemblyVersion\(</span><span style="COLOR: rgb(255,0,0)">&amp;quot;</span><span style="COLOR: rgb(0,0,255)">.*</span><span style="COLOR: rgb(255,0,0)">&amp;quot;</span><span style="COLOR: rgb(0,0,255)">\)\]</span>"<br /><span style="COLOR: rgb(0,0,255)">                </span><span style="COLOR: rgb(255,0,0)">ReplacementText</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">AssemblyVersion(</span><span style="COLOR: rgb(255,0,0)">&amp;quot;</span><span style="COLOR: rgb(0,0,255)">$(Major).$(Minor).$(Build).$(Revision)</span><span style="COLOR: rgb(255,0,0)">&amp;quot;</span><span style="COLOR: rgb(0,0,255)">)]</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />    &lt;/</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>Here we process all the AssemblyInfo.cs files and set them to have a specific version number based on the property values we have defined.<br /><p>First we clear the ReadOnly attribute on the files.  Why? Because TFS sets this attribute when it retrieves the code from source control and unless you have the files checked out they will be read only.<br /><p>We then do a search and replace of the AssemblyVersion values in the AssemblyInfo.cs files using regular expression. We replace the existing code with the specific version we want using the Major, Minor, Build and Revision properties.<br /><p>But where does the Revision number come from?  That’s in the GetTFSVersion target.<br /><h4><a>GetTFSVersion Target</a></h4><pre class="codeblock"><span style="COLOR: rgb(0,0,255)">  &lt;</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Name</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">GetTFSVersion</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />    &lt;</span><span style="COLOR: rgb(163,21,21)">TfsVersion</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">LocalPath</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(CCNetWorkingDirectory)</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />      &lt;</span><span style="COLOR: rgb(163,21,21)">Output</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">TaskParameter</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">Changeset</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">PropertyName</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">Revision</span>"<span style="COLOR: rgb(0,0,255)">/&gt;<br />    &lt;/</span><span style="COLOR: rgb(163,21,21)">TfsVersion</span><span style="COLOR: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="COLOR: rgb(163,21,21)">Message</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Text</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">TFS ChangeSet: $(Revision)</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />    &lt;/</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>This target queries TFS using the TfsVersion tasks to get the latest Changeset number and places this value in the Revision property.<br /><p>MSBuild has a weird syntax for getting return values from tasks.  The Output element shows how it works. The TfsVersion tasks has a parameter called Changeset and when the task completes the parameter value will have a value. We can access this value using the Output element and assign it to a property.  It's a bit like a C# Property Get in concept but it's not a very elegant syntax.<br /><p>We’re also producing a message in the build log for reference (just to show we can).<br /><h4>SetWebVersionInfo Target</h4><br /><p>The last thing we need to do is to add a version file to the web site we are going to compile.<pre class="codeblock"><span style="COLOR: rgb(0,0,255)">  &lt;</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Name</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">SetWebVersionInfo</span>"<span style="COLOR: rgb(0,0,255)">&gt;<br />    &lt;</span><span style="COLOR: rgb(163,21,21)">Version</span><span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">VersionFile</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">MyWebSite\version.txt</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">BuildType</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">None</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">RevisionType</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">None</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Major</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(Major)</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Minor</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(Minor)</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Build</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(Build)</span>"<span style="COLOR: rgb(0,0,255)"> </span><span style="COLOR: rgb(255,0,0)">Revision</span><span style="COLOR: rgb(0,0,255)">=</span>"<span style="COLOR: rgb(0,0,255)">$(Revision)</span>"<span style="COLOR: rgb(0,0,255)"> /&gt;<br />  &lt;/</span><span style="COLOR: rgb(163,21,21)">Target</span><span style="COLOR: rgb(0,0,255)">&gt;<br /></span></pre><br /><p>Here we're just creating a simple version.txt file in a hardcoded location. Remember that there's nothing stopping you from using MSBuild properties to control the location of the version file, or doing something along the lines of what we did with the AssemblyInfo.cs files by putting the version information in a resource file or editing an "about.htm" page.</p><br /><p>After we've done this, we just need to remember to close of the &lt;project&gt; tag, save the build file and we're done.<br /><h4>Try It</h4><br /><p>Give it a run my calling MSBuild from the command line using a statement like<br /><p><pre class="codeblock">MSBuild MyBuildScript.proj /p:Configuration=Debug;Major=2;Minor=4;Build=1 </pre><br /><p><br /><p>Normally you'd want to do this as part of a CI process using Team Build and <a href="http://notgartner.wordpress.com/tag/projects/tfs-integrator/">TFS Integrator</a> or <a href="http://ccnet.thoughtworks.com/">CruiseControl.NET</a>, or any other CI product that allows you to execute MSBuild tasks.<br /><p>For more information on <a href="http://richardsbraindump.blogspot.com/2007/07/using-tfs-source-control-with.html">using CruiseControl.NET with TFS</a> see my post on this subject.<br /><p>Information on MSBuild is available from MSDN. Good starting points are the <a href="http://msdn2.microsoft.com/en-us/library/wea2sca5(VS.80).aspx">MSBuild Overview</a>  and the <a href="http://msdn2.microsoft.com/en-us/library/0k6kkbsd(VS.80).aspx">MSBuild Reference</a>.</p>
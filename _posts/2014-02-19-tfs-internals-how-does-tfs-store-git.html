---
layout: post
title: TFS Internals - How does TFS store Git repositories?
date: '2014-02-19T01:25:00.001+11:00'
author: Richard Banks
tags:
- development
modified_time: '2014-02-19T06:52:24.114+11:00'
thumbnail: http://lh3.ggpht.com/-qVJfDAzUXmU/UwNtB5kEx6I/AAAAAAAABjE/_PLPXDbcFBE/s72-c/image_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-13321238.post-7632038289781660442
blogger_orig_url: http://www.richard-banks.org/2014/02/tfs-internals-how-does-tfs-store-git.html
---

Git in TFS is just Git. Plain old vanilla git. Nothing fancy about it at all.<br /><br />Well, almost. On the server, there is one significant change to be aware of. Files aren’t stored on the file system like they would be when git is running on your local machine. Instead they’re stored in the TFS SQL server database. Apart from that, it's the same as any other git server out there.<br /><br />For a little fun I decided to dig into the TFS 2013 database to see just how the git files are stored.<br /><br /><em>NOTE: Don’t ever go hacking on your TFS databases. You’ll put your system into an unsupported state. All of the information that follows is a result of select statements only.</em><br /><em><br /></em><em>CAVEAT: The information here is based on me digging through the tables in the database. I’ve likely missed some items and may have made some bad assumptions. Feel free to leave a comment if you spot an error so I can correct the post.</em><br /><em><br /></em>Firstly, looking through the tables in the TFS database we find a number of them are named tbl_Git*.&nbsp; This looks like a good place to start. Let’s see what they’re call and then what’s in them,<br /><a href="http://lh3.ggpht.com/-Fax7-SHPQnA/UwNtA5BA8hI/AAAAAAAABi8/1N6lgSJR1gU/s1600-h/image%25255B5%25255D.png"><img alt="image" border="0" src="http://lh3.ggpht.com/-qVJfDAzUXmU/UwNtB5kEx6I/AAAAAAAABjE/_PLPXDbcFBE/image_thumb%25255B1%25255D.png?imgmax=800" height="167" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="219" /></a><br />You’ll note there’s no ‘objects’ or ‘logs’ tables that might mirror the way a normal .git folder would look, though there is tbl_GitRef that might mirror the refs folder and that tbl_GitCommit table looks pretty interesting.<br /><br />To figure out what ends up where, I made a new local repository, added a single commit to it, then pushed it to the git repository on TFS<br /><br />Here’s what I found in each table:<br /><br /><h3>tbl_GitRepository</h3>As you’d expect on a server where you can have multiple repositories, this table just has a list of the repos that have been created. Repositories have partition ids and a Guid for the repository ID, but they also have an ‘InternalRepositoryId’ <br /><br />The InternalRepositoryId is used in other tables as part of their clustered indexes, avoiding the problems of using guids in indexes.<br /><a href="http://lh6.ggpht.com/-z9i3LdkOIcM/UwNtCpr84TI/AAAAAAAABjM/k3YlRzu38RA/s1600-h/image%25255B41%25255D.png"><img alt="image" border="0" src="http://lh5.ggpht.com/-ODE8Gs9nssE/UwNtDLBdBPI/AAAAAAAABjU/pGhvp_SGZ0s/image_thumb%25255B15%25255D.png?imgmax=800" height="49" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="647" /></a><br /><br /><h3>tbl_GitRef</h3>This mimics the refs folder in a normal .git repo. You can see that the refs folder structure is tracked in the ref name and that the ObjectId matches my local repo.<br /><a href="http://lh4.ggpht.com/-Ek87xQNV_AM/UwNtD_aR1FI/AAAAAAAABjc/v6ME9NlOwmI/s1600-h/image%25255B79%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-KFr8p6usu1Y/UwNtEQx3pNI/AAAAAAAABjk/MBL-NMvx0Cw/image_thumb%25255B37%25255D.png?imgmax=800" height="53" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="335" /></a><br /><br /><a href="http://lh4.ggpht.com/-wR4lF3kGqKI/UwNtE8-x77I/AAAAAAAABjs/ce5_LUcxuF8/s1600-h/image%25255B28%25255D.png"><img alt="image" border="0" src="http://lh6.ggpht.com/-3BjbJye-RmQ/UwNtFm0EJ1I/AAAAAAAABj0/4gy6CD_v_JA/image_thumb%25255B10%25255D.png?imgmax=800" height="78" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="725" /></a><br /><br /><h3>tbl_GitRefLog</h3>This is as you might expect, a log of changes for the various refs. The thing to note here is that there is a pushId maintained in the table as well.<br /><a href="http://lh3.ggpht.com/-VfdVS5mX7WY/UwNtGbkiq_I/AAAAAAAABj8/7Xu1C-TF1tw/s1600-h/image%25255B78%25255D.png"><img alt="image" border="0" src="http://lh5.ggpht.com/-juc1gkQsc6s/UwNtG-RCHdI/AAAAAAAABkE/npYumF2K318/image_thumb%25255B36%25255D.png?imgmax=800" height="50" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="731" /></a><br /><br /><h3>tbl_GitPush</h3>Talking of push operations, tbl_GitPush is used purely to track the time of a push and who the person was who did it (via a Guid). Nothing much to see here, so let’s move on.<br /><br /><h3>tbl_GitPluginProcessedCommit</h3>This looks to be a simple log of what jobs were executed against which commits.<br /><br /><h3>tbl_GitCommit</h3>OK, so this one as it turns out is pretty straightforward. It’s a table of git commit SHA1’s mapped to internal commit ids.<br /><br />My local git commit was as follows:<br /><a href="http://lh6.ggpht.com/-t-yKwus9n4Y/UwNtHQ5FjZI/AAAAAAAABkM/lqbixi8HnXM/s1600-h/image%25255B20%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-Qlkx0hk9A54/UwNtINGULXI/AAAAAAAABkU/3g3dHqjHJxM/image_thumb%25255B6%25255D.png?imgmax=800" height="146" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="244" /></a><br />On the server we can see the commit’s SHA1 in this table with an InternalCommitId (unique across repositories by the looks of it) and what push it was related to.<br /><a href="http://lh5.ggpht.com/-b8wfEk_-NYc/UwNtI_HeQlI/AAAAAAAABkc/qUgHS_0vAOQ/s1600-h/image%25255B52%25255D.png"><img alt="image" border="0" src="http://lh5.ggpht.com/-KGXVMhKpp6M/UwNtJkQnagI/AAAAAAAABkk/B46EmkawzOg/image_thumb%25255B20%25255D.png?imgmax=800" height="52" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="663" /></a><br /><br /><h3>tbl_GitCommitMetadata</h3>This table is for the commit comments and foreign key values for the committer and author. <br /><a href="http://lh6.ggpht.com/-Cs4AJtRuVMU/UwNtKLLSmnI/AAAAAAAABks/s2yXtz-hNco/s1600-h/image%25255B53%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-UW-j757wIZw/UwNtKml6vdI/AAAAAAAABk0/ervkqNqIYQQ/image_thumb%25255B21%25255D.png?imgmax=800" height="47" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="742" /></a><br /><br /><h3>tbl_GitCommitParent</h3>Since git tracks the parents of each commit, this table is used for that information. My example commit here has no parents so there’s nothing to show. The table itself only has three columns. The partition id, the InternalCommitId and a ParentInternalCommitId.<br /><br />When you have merge commits, for example you will end up with multiple rows, as shown in this example. Note again the use of the internal ids instead of SHA1s to allow for clustered indexes on the tables.<br /><a href="http://lh5.ggpht.com/-VXV2m8vvYLA/UwNtLQNEiNI/AAAAAAAABk8/blAk7GbDM8Q/s1600-h/image%25255B54%25255D.png"><img alt="image" border="0" src="http://lh3.ggpht.com/-5H64TypuTF8/UwNtLwL4eMI/AAAAAAAABlE/I4KDgTN0a54/image_thumb%25255B22%25255D.png?imgmax=800" height="68" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="342" /></a><br /><br /><h3>tbl_GitCommitUser</h3>As alluded to before, this is simple a reference table of user InternalId values to names. Here’s my record for example<br /><a href="http://lh4.ggpht.com/-tFodttt7h8M/UwNtMvUy3HI/AAAAAAAABlM/wpSZrTs5-Mk/s1600-h/image%25255B56%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-LTXzB4_U91s/UwNtNMXIBKI/AAAAAAAABlU/UHL3NBmJSPU/image_thumb%25255B24%25255D.png?imgmax=800" height="48" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="562" /></a><br /><br /><h3>tbl_GitCommitChanges</h3>So we’re on the last table with a git name. Looking at this for our commit we see the following<br /><a href="http://lh4.ggpht.com/-rRZlDzHhuN4/UwNtNvxOvdI/AAAAAAAABlc/Lip9Bme_bzk/s1600-h/image%25255B51%25255D.png"><img alt="image" border="0" src="http://lh6.ggpht.com/-f9Q099_DS4M/UwNtOQ0JkJI/AAAAAAAABlk/DrN0DDogk-I/image_thumb%25255B19%25255D.png?imgmax=800" height="50" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="734" /></a><br />It’s indicating there was a file changed in the root of the git repo named aa.txt. Great. But where’s the content?<br /><br />It turns out that TFS doesn’t hold the git content in a Git prefixed table, but somewhere else. There’s actually a few more tables in use, so let’s keep digging.<br /><br /><h3>tbl_Container</h3>Remember that GUID for the git repository we saw, right back at the start? We if we look at the container table we see that GUID referenced in an artifact URI on this table.<br /><a href="http://lh4.ggpht.com/-IHB1yd-bRHg/UwNtO3ZF2XI/AAAAAAAABls/AX1WOfrIK2w/s1600-h/image%25255B57%25255D.png"><img alt="image" border="0" src="http://lh6.ggpht.com/-baHeg-9aCH0/UwNtPR9ZP8I/AAAAAAAABl0/z8SmhawG1rU/image_thumb%25255B25%25255D.png?imgmax=800" height="111" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="758" /></a><br />This ‘container’ URI is actually a reference to a location on the file system. Where? you might ask. Where indeed. If you look under the TFS Application Tier folder you will find a _tfs_data folder. Drill down past that to the Proxy folder and under that you will should find a folder with the same name as our repository’s GUID.<br /><br />Look in there and you’ll find some interesting items, like those PACK files I’ve highlighted. These are your standard git PACK files.&nbsp; TFS is storing the data directly in the database but rather in the standard git pack format for efficiency. Interestingly the idx and pack files don’t share the same name as they would on a normal file system based git repo. I’m not sure why.<br /><a href="http://lh4.ggpht.com/-qRFhuXxgmd4/UwNtQPqQXtI/AAAAAAAABl8/Sj1yi50zdA8/s1600-h/image%25255B80%25255D.png"><img alt="image" border="0" src="http://lh5.ggpht.com/-K1Jk1RRp4WI/UwNtRM3ZrxI/AAAAAAAABmE/GHsY6rzcMh4/image_thumb%25255B38%25255D.png?imgmax=800" height="301" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="644" /></a><br />The statement that TFS stores the files on the file system is not entirely true. They’re probably there for performance reasons as if source was only stored on the file system, then the git content wouldn’t be backed up when SQL was backed up and that wouldn’t make people happy when they needed to restore a backup. So let’s see what else we can find.<br /><br /><h3>tbl_ContainerItem</h3>If we select all items in the container item table we see the following. We can see the pack and index files we saw on the file system, but we also see that each has a file id and a file length. <br /><a href="http://lh4.ggpht.com/-GV5cRCHcDME/UwNtRoNyi6I/AAAAAAAABmM/hvUphwrHX2M/s1600-h/image%25255B68%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-1NaieC2l6TI/UwNtS9i9TtI/AAAAAAAABmU/8AEt7cFV2lI/image_thumb%25255B30%25255D.png?imgmax=800" height="112" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="644" /></a><br /><br /><h3>tbl_File</h3>These fileids are part of the the tbl_File table which is effectively a mapping of a file id to a resource id.<br /><a href="http://lh4.ggpht.com/-ed4raPblrFQ/UwNtTh5mMuI/AAAAAAAABmc/dWBkqJfnNko/s1600-h/image%25255B72%25255D.png"><img alt="image" border="0" src="http://lh4.ggpht.com/-8EPBKAWTc6w/UwNtUPcon6I/AAAAAAAABmg/0plvvZ3IGBY/image_thumb%25255B32%25255D.png?imgmax=800" height="141" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="669" /></a><br />OK. One last stop – where are these resources?<br /><br /><h3>tbl_Content</h3>Finally, we arrive at our destination. The Content column is a varbinary(max) column (i.e. blob storage) and contains our encoded content. Lovely!<br /><a href="http://lh5.ggpht.com/-wInLPnXheQU/UwNtUi4fX0I/AAAAAAAABmo/ee_Edux-a_c/s1600-h/image%25255B77%25255D.png"><img alt="image" border="0" src="http://lh6.ggpht.com/-5RCy3xbeDqo/UwNtVTLNHWI/AAAAAAAABm0/-zvOTYlBHh8/image_thumb%25255B35%25255D.png?imgmax=800" height="184" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="714" /></a><br />As for where the aa.txt file lives, well that’s going to be determined by git not TFS. Git will look at the index file and use that to decide where in the related pack file it should extract the content from. You’ll want to be looking into gits internals if you want to understand this process. See <a href="http://git-scm.com/book/en/Git-Internals-Packfiles" title="http://git-scm.com/book/en/Git-Internals-Packfiles">http://git-scm.com/book/en/Git-Internals-Packfiles</a> for a good run through on this if you’re interested.<br /><br /><br />That’s about it for now. I think it’s pretty interesting to see how it all works under the hood and I hope you enjoyed the walkthrough.
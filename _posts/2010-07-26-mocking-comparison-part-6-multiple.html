---
layout: post
title: 'Mocking Comparison – Part 6: Multiple Calls'
date: '2010-07-26T14:54:00.001+10:00'
author: Richard Banks
tags:
- mocking
modified_time: '2010-08-06T08:55:41.052+10:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-1209947817875887764
blogger_orig_url: http://www.richard-banks.org/2010/07/mocking-comparison-part-6-multiple.html
---

<p>Our comparison of Rhino Mocks, Moq and NSubstitute continues with a look at how multiple calls to a mock are handled and what you do if you want to alter the return values on subsequent calls.</p>  <p>Consider the scenario where you have a method you’re calling that you want to be successful the first time you call it, but where subsequent calls should fail (such as trying to save the same data twice, etc).&#160; How do you do this?</p>  <h3>Rhino Mocks</h3>  <p>In Rhino Mocks to set return values for multiple calls to a method you simply specify the return value that many times.&#160; To avoid duplication of code you can use the repetition syntax we saw in <a title="Repetition Syntax" href="http://www.richard-banks.org/2010/07/mocking-comparison-part-5-repetitions.html" target="_blank">Part 5</a>.</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:f9e12d94-b560-41d6-9f31-b2908a3a8e32" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Rhino_multiple_calls()<br />{<br /> var monkey = MockRepository.GenerateMock&lt;IMonkey&gt;();<br /><br /> monkey.Stub(m =&gt; m.TryAddFleas(1)).Return(true).Repeat.Twice();<br /> monkey.Stub(m =&gt; m.TryAddFleas(1)).Return(false);<br /><br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.False(monkey.TryAddFleas(1));<br />}</pre></div><p>Given that we have set up the return value 3 times, what happens when we make the call a fourth time?&#160; At this point Rhino Mocks, having exhausted it’s known set of return values, will start returning the default value.</p><p>What if you just want to return the value True for every call?&#160; We would use the Repeat.Any() method as shown here:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:4df2220f-1f57-444a-aba8-cf3ba174a480" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Rhino_multiple_calls()<br />{<br /> var monkey = MockRepository.GenerateMock&lt;IMonkey&gt;();<br /><br /> monkey.Stub(m =&gt; m.TryAddFleas(1)).Return(true).Repeat.Any();<br /><br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.True(monkey.TryAddFleas(1));<br />}</pre></div><h3>Moq</h3><p>Moq doesn’t have a nice way of defining mixed return values (not that I can find anyway) however you can implement the same thing using callbacks, which we’ll cover in a later post.</p><p>By default setting a return value on a method call will always return that value no matter how many times it is called, so we can at least do the following:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:915c60f5-6144-4906-b1d3-48b5f53ee898" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Moq_multiple_calls()<br />{<br /> var monkey = new Mock&lt;IMonkey&gt;();<br /> monkey.Setup(m =&gt; m.TryAddFleas(1)).Returns(true);<br /><br /> Assert.True(monkey.Object.TryAddFleas(1));<br /> Assert.True(monkey.Object.TryAddFleas(1));<br />}</pre></div><h3>NSubstitute</h3><p>The code for mixed return values in NSubstitute is so nice.&#160; To handle multiple calls providing different return values you can just provide multiple values or use an array in the return statement as follows:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:1ba69e4e-efd6-49e0-acaa-452939161757" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Nsubstitute_multiple_calls()<br />{<br /> var monkey = Substitute.For&lt;IMonkey&gt;();<br /><br /> monkey.TryAddFleas(1).Returns(true,true,false);<br /><br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.False(monkey.TryAddFleas(1));<br />}</pre></div><p>And if you just want to always return true, then it works just like Moq does (with the benefit of not requiring the .Object. tax in the assert statements:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:a9a7971f-f5dc-4f4f-ae52-6233f807b418" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Nsubstitute_multiple_calls()<br />{<br /> var monkey = Substitute.For&lt;IMonkey&gt;();<br /><br /> monkey.TryAddFleas(1).Returns(true);<br /><br /> Assert.True(monkey.TryAddFleas(1));<br /> Assert.True(monkey.TryAddFleas(1));<br />}</pre></div><p>If you can’t tell, my decision on the best framework to choose goes to NSubstitute.&#160; It has such a simple and elegant way to handle both requirements, and again, not a single lambda in site.&#160; Excellent!</p><p>&nbsp;</p><p>Other posts in this series:<ul><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-1-basics.html">1: The Basics</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-2-properties.html">2: Properties</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-3-interactions.html">3: Interactions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-4-parameter.html">4: Parameter Constraints</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-5-repetitions.html">5: Repetitions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-7-exceptions.html">7: Exceptions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-8-recursive.html">8: Recursive Mocks</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-9-functions.html">9: Functions</a></li><li><a href="http://www.richard-banks.org/2010/08/mocking-comparison-part-10-events.html">10: Events</a></li><li><a href="http://www.richard-banks.org/2010/08/mocking-comparison-part-11-multiple.html">11: Multiple Interfaces</a></li><li><a href="http://www.richard-banks.org/2010/08/mocking-comparison-part-12-unmockables.html">12: The UnMockables</a></li></ul></p>
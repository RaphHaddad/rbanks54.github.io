---
layout: post
title: Using Team Build to Deploy Database Projects to Different Servers
date: '2007-11-06T17:50:00.001+11:00'
author: Richard Banks
tags:
- database
- readify
- TFS
modified_time: '2007-11-06T17:50:42.954+11:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-2453926486565545129
blogger_orig_url: http://www.richard-banks.org/2007/11/using-team-build-to-deploy-database.html
---

<p>I had a situation recently where I was building a solution that contained a Database project (.dbproj) built using Visual Studio 2005 Team Edition for Database Professionals (aka DataDude).</p> <p>In Team Build there were two different build types.&nbsp; One for Continuous Integration and one for the Nightly Build.&nbsp; The CI build simply compiled the solution and ran some tests locally, whereas the nightly build also deployed the database to a test server and refreshed the application on the test server.</p> <p>As part of the build process I had something like this in the project file:</p> <p><pre class="codeblock"><span style="color: rgb(0,0,255)">&lt;</span><span style="color: rgb(163,21,21)">PropertyGroup</span><span style="color: rgb(0,0,255)">&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">TargetConnection_A</span><span style="color: rgb(0,0,255)">&gt;</span>DataSource=ServerA%3BIntegrated Security=True%3BPooling=False%3B<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">TargetConnection_A</span><span style="color: rgb(0,0,255)">&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">TargetConnection_B</span><span style="color: rgb(0,0,255)">&gt;</span>DataSource=ServerB%3BIntegrated Security=True%3BPooling=False%3B<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">TargetConnection_B</span><span style="color: rgb(0,0,255)">&gt;<br />&lt;/</span><span style="color: rgb(163,21,21)">PropertyGroup</span><span style="color: rgb(0,0,255)">&gt;<br />&lt;</span><span style="color: rgb(163,21,21)">Target</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Name</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">xxx</span>"<span style="color: rgb(0,0,255)">&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">Message</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Text</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">Deploying Database Locally</span>"<span style="color: rgb(0,0,255)"> /&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">MSBuild</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Projects</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">db1.dbproj</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Targets</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">Build;Deploy</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Properties</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">TargetConnectionString=$(TargetConnection_A)</span>"<span style="color: rgb(0,0,255)"> /&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">Message</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Text</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">Deploying Database Locally</span>"<span style="color: rgb(0,0,255)"> /&gt;<br />  &lt;</span><span style="color: rgb(163,21,21)">MSBuild</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Projects</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">db1.dbproj</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Targets</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">Deploy</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Properties</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">TargetConnectionString=$(TargetConnection_B)</span>"<span style="color: rgb(0,0,255)"> /&gt;<br />&lt;/</span><span style="color: rgb(163,21,21)">Target</span><span style="color: rgb(0,0,255)">&gt;<br /></span></pre><br /><p></p><br /><p>Simple enough, really.&nbsp; To do the second deployment you just change the connection string for the database project and re-deploy, right?&nbsp; Well, actually it's not.&nbsp; If you try this you'll get an error in your build log that looks something like this:</p><br /><p><pre class="codeblock">Deploy error TSD151: .Net SqlClient Data Provider: Msg 50000, Level 16, State 127, Line xx The server name in the build script ServerB does not match the name of the target server ServerA.&nbsp; Verify whether your database project settings are correct and whether your build script is up to date.</pre><br /><p></p><br /><p>This is a bit surprising, especially as the build &amp; deploy to Server A works correctly.</p><br /><p>Well, as it turns out, when a database project is built it creates one huge uber-script and embeds within it the knowledge of the server it should be deployed to.&nbsp; It also adds a check that the server in the connection string matches the server it thinks it should be deploying to, so even though you change the connection string before calling the script you'll get an error occurring based on the fact that the servers don't match.</p><br /><p>If you look at the <a href="http://msdn2.microsoft.com/en-us/library/aa833289(VS.80).aspx" target="_blank">MSDN documentation</a> on this topic they'll tell you to modify the database project settings directly in order for the deploy to work in Team Build, however this is a flawed approach as changing the project properties will affect everyone in the team (and you don't want them all deploying to the one database by default, do you?) and it also doesn't solve the problem of deploying the database twice.</p><br /><p>Now you could try changing the targets in the second MSBuild step to use "Clean;Build;Deploy" as the targets but what happens in this case is that the compiler determines that the source hasn't changed and it therefore has nothing to do, and the uber-script isn't changed.&nbsp; As such you'll still received the same error as before.</p><br /><p>The solution then is to force a rebuild.&nbsp; This is easily done by changing the targets for the second MSBuild to use "Rebuild;Deploy" as shown here.</p><br /><p><pre class="codeblock"><span style="color: rgb(0,0,255)">&lt;</span><span style="color: rgb(163,21,21)">MSBuild</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Projects</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">db1.dbproj</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Targets</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">Rebuild;Deploy</span>" <span style="color: rgb(255,0,0)">Properties</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">TargetConnectionString=$(TargetConnection_B)</span>"<span style="color: rgb(0,0,255)"> /&gt;<br /></span></pre><br /><p></p><br /><p>Once you've done that, everything should work and your builds will then deploy the database to multiple servers as expected.</p> 
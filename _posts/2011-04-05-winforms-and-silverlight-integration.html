---
layout: post
title: WinForms and Silverlight Integration With a Twist
date: '2011-04-05T15:34:00.000+10:00'
author: Richard Banks
tags:
- silverlight
modified_time: '2011-04-05T15:34:03.600+10:00'
thumbnail: http://lh4.ggpht.com/_5dD_rBQSs2o/TZqn9bgQijI/AAAAAAAABC0/pdEMYb0lRrA/s72-c/image_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-13321238.post-7906839850292106361
blogger_orig_url: http://www.richard-banks.org/2011/04/winforms-and-silverlight-integration.html
---

<p>I’m doing some work with a customer at the moment that has a large and complex application written in Progress, and they are wanting to do some work to add new features to it, but want to do so via Silverlight.</p>  <p>Now the way this application works from a UI perspective is that there is an application host shell with a menu and so forth, and when people request a screen it creates a new tab and hosts the appropriate screen in that tab.&#160; That screen could be a Progress GUI screen, a console screen or a web page, and now we need to add Silverlight screens to the mix as well.</p>  <p>Something like this:</p>  <p><a href="http://lh4.ggpht.com/_5dD_rBQSs2o/TZqn8f3EntI/AAAAAAAABCw/ockzMvx7aQs/s1600-h/image3.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TZqn9bgQijI/AAAAAAAABC0/pdEMYb0lRrA/image_thumb1.png?imgmax=800" width="484" height="156" /></a></p>  <p>Now for this to work we have to jump through a few hoops.&#160; We need Silverlight to be hosted in a web page, which means we’ll need to host a web browser control somewhere.&#160; We’ll also need to host that browser control in a WinForms user control since in Progress we can add a wrapper around the user control to make the whole thing callable via the Progress shell, as well as being able to receive events.&#160; When it’s put together it looks something like this:</p>  <p><a href="http://lh6.ggpht.com/_5dD_rBQSs2o/TZqn9px9SBI/AAAAAAAABC4/-EnnCCstiyk/s1600-h/image8.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_5dD_rBQSs2o/TZqn-fbZfuI/AAAAAAAABC8/1uESkElc-cg/image_thumb4.png?imgmax=800" width="231" height="244" /></a></p>  <p>What we’re also going to do is make sure we have just one Silverlight application containing all the Silverlight forms we want.&#160; We don’t want to create an application per form since that would likely turn into a huge maintenance and deployment problem and make development overly complex.</p>  <p>Now for all of this to work we will use the Silverlight to HTML bridge as well as the ability to have pages in the WebBrowser control talk to a .NET object via COM.</p>  <h2>Wrap the WebBrowser Control</h2>  <p>Let’s start by wrapping the web browser control.&#160; We could simply subclass it to do what we need, but if we do we won’t be able to get information back from the Silverlight UI the way we want, so we’ll instead create a custom user control and host the WebBrowser in that.</p>  <p>We’ll also create a few methods on the control to navigate to the page where the Silverlight application is hosted, and to request the particular Silverlight form we want.</p>  <p>Now this code isn’t quite so straightforward since we have some timing issues to deal with.&#160; If the Progress code simply calls “Navigate” and then “Open Form” I could be requesting information from the Silverlight application before either the web page or the Silverlight app has finished loading and if that happens then we’ll have errors thrown in our UI.&#160; This isn’t so good.&#160; We need to wait until things are ready before commencing.</p>  <p><a href="http://lh3.ggpht.com/_5dD_rBQSs2o/TZqn-y1hXiI/AAAAAAAABDA/d0KvZoKeI6c/s1600-h/image11.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TZqn_8b2Q1I/AAAAAAAABDE/zhA-NWK6IPY/image_thumb5.png?imgmax=800" width="200" height="244" /></a></p>  <p>Here’s the code we need.&#160; Note that a variable number of arguments for the Silverlight pages is catered for by passing an Object[] array as a parameter.</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:46d4597d-1d6d-4eca-b7ed-e0066862f311" class="wlWriterEditableSmartContent"><pre class="brush: c#;">public partial class SilverlightHost : UserControl<br />{<br /> public SilverlightHost()<br /> {<br />  InitializeComponent();<br />  webBrowser1.AllowNavigation = false;<br />  webBrowser1.AllowWebBrowserDrop = false;<br />  webBrowser1.IsWebBrowserContextMenuEnabled = false;<br />  webBrowser1.WebBrowserShortcutsEnabled = false;<br />  webBrowser1.DocumentCompleted += (s, e) =&gt; documentLoaded = true;<br /> }<br /><br /> public void LoadSilverlightFrom(string url)<br /> {<br />  NavigateToUrl(url);<br /> }<br /><br /> private bool documentLoaded = false;<br /><br /> private void NavigateToUrl(string url)<br /> {<br />  documentLoaded = false;<br />  webBrowser1.Navigate(url);<br /> }<br /><br /> public void ShowForm(string formName, object[] parameters)<br /> {<br />  while (!documentLoaded)<br />   Application.DoEvents();<br />  var args = new List&lt;object&gt; {formName};<br />  if (parameters != null)<br />   args.AddRange(parameters);<br />  webBrowser1.Document.InvokeScript("ShowForm", args.ToArray());<br /> }<br />}</pre></div><h2>Edit the Web Page For Silverlight Interaction</h2><p>The keen of sight will have noticed that in the ShowForm method above we call a JavaScript script on the web page called ShowForm.&#160; This is not a standard script, we need to go and add it.</p><p>We’ll also need to do a little work in our JavaScript to handle the fact that the script can be called before the Silverlight object has actually completed initialisation.</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:b5edde9a-4861-4ec9-b903-439d241fdc7f" class="wlWriterEditableSmartContent"><pre class="brush: javascript; highlight: [9];">&lt;body&gt;<br />    &lt;form id="form1" runat="server" style="height:100%"&gt;<br />    &lt;div id="silverlightControlHost"&gt;<br />        &lt;object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="100%" height="100%" id="silverlightControl"&gt;<br />   &lt;param name="source" value="ClientBin/HostedSilverlightPOC.xap"/&gt;<br />   &lt;param name="onError" value="onSilverlightError" /&gt;<br />   &lt;param name="background" value="white" /&gt;<br />   &lt;param name="minRuntimeVersion" value="4.0.50826.0" /&gt;<br />   &lt;param name="onload" value="SilverlightLoaded" /&gt;<br />   &lt;param name="autoUpgrade" value="true" /&gt;<br />   &lt;a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50826.0" style="text-decoration:none"&gt;<br />   &lt;img src="http://go.microsoft.com/fwlink/?LinkId=161376" alt="Get Microsoft Silverlight" style="border-style:none"/&gt;<br />   &lt;/a&gt;<br />    &lt;/object&gt;&lt;iframe id="_sl_historyFrame" style="visibility:hidden;height:0px;width:0px;border:0px"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;/form&gt;<br /><br />    &lt;script type="text/javascript"&gt;<br />        var silverlightReady = false;<br />        var navigateToFunction;<br />        var formName;<br />        var args;<br /><br />        function SilverlightLoaded(sender, args) {<br />            silverlightReady = true;<br />            if (typeof(navigateToFunction) == 'function')<br />                navigateToFunction();<br />        }<br /><br />        function ShowForm() {<br />            args = Array.prototype.slice.call(arguments);  <br />            formName = args.shift();<br />            var control = document.getElementById('silverlightControl');<br />            if (silverlightReady)<br />                control.Content.Page.NavigateTo(formName, args);<br />            else<br />                navigateToFunction = function () {<br />                    control.Content.Page.NavigateTo(formName, args);<br />                };<br />        }<br />    &lt;/script&gt;<br />&lt;/body&gt;</pre></div><p>So a few things to note. First we hook the Silverlight onLoad event (highlighted) and use it to set a Boolean indicating wether the control has finished loading or not.&#160; Once the loading is complete the SilverlightLoaded function is processed where it toggles the flag and calls the navigateToFunction, if it’s been populated.</p><p>In the ShowForm function we check if the Silverlight control has loaded and if it has we call the NavigateTo method (we’ll get to that in a minute) and if not we populate the navigateToFunction which will be called once Silverlight has finished loading.</p><p>If you’re wondering the JavaScript call will mash the form name and the Object array for the parameters into a single arguments variable.&#160; We strip the form</p><p>And yes, for those wondering, this code can be made DRYer and cleaner. I left it like this to (hopefully) aid understanding.</p><h2>The HTML to Silverlight Bridge</h2><p>So now we have our WinForms control calling the JavaScript on our web page, but we now need to do a few things in Silverlight to receive that call.&#160; This is pretty simple:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:d35ecdad-cce3-4d4a-88cd-9ce03fe3b8b9" class="wlWriterEditableSmartContent"><pre class="brush: c#;">public partial class NavigationControl : UserControl<br />{<br /> public NavigationControl()<br /> {<br />  InitializeComponent();<br />  HtmlPage.RegisterScriptableObject("Page", this);<br /><br />  pageLaunchers.Add("Main", (p) =&gt;<br />  {<br />   var mp = new MainPage();<br />   mp.textBox1.Text = (string)p[0];<br />   return mp;<br />  });<br />  pageLaunchers.Add("AnotherOne", p =&gt;<br />  {<br />   var page = new AnotherOne();<br />   return page;<br />  });<br /> }<br /><br /> private readonly Dictionary&lt;string, Func&lt;IList&lt;object&gt;, UserControl&gt;&gt; pageLaunchers = new Dictionary&lt;string, Func&lt;IList&lt;object&gt;, UserControl&gt;&gt;();<br /><br /> [ScriptableMember]<br /> public void NavigateTo(string controlName, ScriptObject parameterList)<br /> {<br />  var paramList = parameterList.ConvertTo&lt;List&lt;object&gt;&gt;();<br />  var launcher = pageLaunchers[controlName];<br />  LayoutRoot.Children.Clear();<br />  var form = launcher(paramList);<br />  LayoutRoot.Children.Add(form);<br /> }<br />}</pre></div><p>The Navigation control here is an empty user control.&#160; There is nothing in it by default so we can load other controls up into it as the host.&#160; These other controls are the pages that we’re wanting our Progress code to be able to call.</p><p>Now to get the Silverlight bridge working we simply register the user control as a scriptable object and then mark the methods we want available to JavaScript with the [ScriptableMember] attribute.&#160; What you’ll note is that the Object[] array from JavaScript comes through to our Silverlight method as a ScriptObject.&#160; We need to convert it in Silverlight to an object collection before we can do things with it.</p><p>You’ll also notice that we’re using a collection of initialiser methods to avoid huge case or if statements that map from the string form name we pass through from the WinForms control to the actual form we’re wishing to display.</p><p>When we receive a request to load a form we check the collection for an initialiser, clear the current page and initialise the new one.&#160; Once we have a reference to it, we load the form up as a child of the navigation control which will automatically show it to our end users, and we’re done.</p><h2>Raising Events Back In WinForms</h2><p>So we can now display any form we want to from Progress.&#160; We then want to be able to click a button in Silverlight and have an event with some attached data raised back in WinForms for Progress to listen to.&#160; Let’s create an event indicating that the Silverlight app is asking the host app to open another form, such as a console or Progress GUI form.</p><p>In Silverlight we can create a simple method as follows:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:237a6af6-b3db-4d1a-966b-1fd9c6b8283c" class="wlWriterEditableSmartContent"><pre class="brush: c#;">public static void AskHostForForm(string formName, string p1 = "", string p2 = "", string p3 = "")<br />{<br /> var form = (ScriptObject)HtmlPage.Window.GetProperty("external");<br /> form.Invoke("AskHostToOpenForm", formName, p1, p2, p3);<br />}</pre></div><p>And call this from a button click event.&#160; For ease of use by all forms this has been made static and resides in the NavigationControl class.</p><p>The HtmlPage.Window.GetProperty(“external”) call will retrieve from the web page hosting the Silverlight control any external reference objects on it.&#160; In our case that’s going to be the WinForms control.&#160; And we’re going to need to ensure that we create an AskHostToOpenForm method</p><p>Back in our WinForms control we need to now expose our control as a ComVisible component and tell the WebBroswer control that it is an ObjectForScripting.&#160; Doing so will automatically make all public methods on the control available for calling either from JavaScript or from Silverlight via the HTML Bridge as shown in the code snippet above.</p><p>We also need to add some code to our WinForms custom control to raise an event when the method is called (so that Progress can do something with it)</p><p>Here’s the code.</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:8ece94bd-36ce-48c6-b08a-48497b23667b" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[ComVisible(true)]<br />public partial class SilverlightHost : UserControl<br />{<br /> public event OpenFormRequestedHandler OpenFormRequested;<br /><br /> public SilverlightHost()<br /> {<br />  InitializeComponent();<br />  ...<br />  webBrowser1.ObjectForScripting = this;<br /> }<br /><br /> ...<br /><br /> public void AskHostToOpenForm(string formName, string p1, string p2, string p3)<br /> {<br />  var args = new OpenFormRequestedArgs(formName, new object[] {p1, p2, p3});<br />  if (OpenFormRequested != null)<br />  {<br />   OpenFormRequested(this, args);<br />  }<br /> }<br />}<br /><br />public delegate void OpenFormRequestedHandler(object sender, OpenFormRequestedArgs args);</pre></div><p>You’ll see that the number of parameters is fixed.&#160; I tried messing about with a variable number of arguments but when I did so the parameters were simply COM objects and there’s no way I was going to mess around with COM :-)&#160; I’m not that crazy!</p><h2>Wrap Up</h2><p>So there we have it, we can now have a Progress application (or any other WinForms app) that hosts a Silverlight form within a tab of the application and be able to get events back from that form when required.</p><p><a href="https://github.com/rbanks54/RichardsSamples/tree/master/HostedSilverlightPOC">The code for this is up on GitHub</a>, so feel free to grab it and have a look at how it all fits together.&#160; If you’ve got any improvements to it that you want to suggest then please let me know.&#160; I’m always happy to get feedback!</p>
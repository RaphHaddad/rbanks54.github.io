---
layout: post
title: 'Mocking Comparison – Part 12: The UnMockables'
date: '2010-08-06T08:35:00.001+10:00'
author: Richard Banks
tags:
- mocking
modified_time: '2010-08-06T08:57:46.073+10:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-1381973638938305662
blogger_orig_url: http://www.richard-banks.org/2010/08/mocking-comparison-part-12-unmockables.html
---

<p>The frameworks we’ve been looking at in previous parts only work well when they can override the properties of the classes you wish to mock, or when you use interfaces. So what happens when you need to deal with a test that is time dependant, or if you want to verify data being written to the console or you have to deal with SharePoint or other similar products that are a dogs vomit of static classes, sealed types and leaky abstractions that make testing with them almost impossible using normal techniques?</p>  <p>The answer is to move away from regular mocking frameworks and use tools like <a href="http://site.typemock.com/typemock-isolator-product" target="_blank">TypeMock Isolator</a>, <a href="http://research.microsoft.com/en-us/projects/moles/" target="_blank">Microsoft Moles</a> or <a href="http://www.telerik.com/products/mocking.aspx" target="_blank">Telerik Just Mock</a> (as a note, I don’t have a copy of JustMock so I’m going to leave it out of this series)</p>  <h3>DateTime.Now</h3>  <p>So let’s say you’ve got a class that references DateTime.Now and changes behaviour based on the time of day. How do you test behaviour correctly and more importantly,how do you do this reliably?&#160; You can’t really mess with the system clock.&#160; The trick is to intercept the call to DateTime.Now and provide your own method that gets called instead, and this is what TypeMock and Moles both allow you to do.</p>  <h3>TypeMock</h3>  <p>Here’s the basic code for mocking out DateTime.Now with TypeMock</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:e6d48133-5510-45b7-8d3e-f269571b5bfb" class="wlWriterEditableSmartContent"><pre class="brush: c#;">readonly DateTime dateToUse = new DateTime(2010, 07, 17, 8, 0, 0);<br /><br />[Fact]<br />public void Isolate_current_time()<br />{<br /> Isolate.WhenCalled(() =&gt; DateTime.Now).WillReturn(dateToUse);<br /> Assert.Equal(dateToUse, DateTime.Now);<br />}<br /></pre></div><p>Pretty simple stuff.</p><p>If you wanted to provide a method implementation rather the just returning a value you would replace the .WillReturn() call with .DoInstead() </p><p>So let’s see what this looks like in a test.&#160; Once again, this is somewhat testing the mock which you shouldn’t do in the real world, but it does show you what the syntax is like, which is the goal after all.</p><p>Oh, as a reminder the relevant code from the class under test is as follows:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:263b9194-8005-49a1-8c59-4bc097e37c11" class="wlWriterEditableSmartContent"><pre class="brush: c#;">public void CleanMonkey()<br />{<br /> // &lt;snip!&gt;<br /> if (AssignedMonkey.IsAwake(DateTime.Now))<br />  AssignedMonkey.Clean();<br />}</pre></div><p>So in our test we are going to set the mock to only return true if the time passed to the IsAwake method matches our specific date time.&#160; In other words, we should see that DateTime.Now is returning the value we specify, not the current time.</p><p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:f2891b08-c037-4272-ad38-05b5fd5b15d9" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />public void Isolate_monkey_should_be_awake()<br />{<br /> Isolate.WhenCalled(() =&gt; DateTime.Now).WillReturn(dateToUse);<br /><br /> var monkey = Substitute.For&lt;IMonkey&gt;();<br /> monkey.CurrentFleaCount().Returns(20);<br /> monkey.IsAwake(Arg.Is(dateToUse)).Returns(true);<br /><br /> var keeper = new ZooKeeper();<br /> keeper.AssignedMonkey = monkey;<br /><br /> keeper.CleanMonkey();<br /><br /> monkey.Received().Clean();<br />}</pre></div></p><p>And as expected, this test works.&#160; Now the keen eyed amongst you will see that I’m actually mixing TypeMock Isolator and NSubstitute in the one test.&#160; I’m using Isolator to mock out the static DateTime.Now method and NSubstitute to create the mock monkey object.</p><p>Also, in terms of running, the tests there’s a few little changes to the tests and things take longer because Isolator is injecting itself in your code.&#160; The other thing to note is that DateTime is part of the Base Class Library and TypeMock doesn’t support all of the methods in the BCL, just certain methods so if you want to mock out a method Isolator doesn’t support you’re on you own.</p><h3>Mircosoft Moles</h3><p>Moles is a framework that is usually obtained with the Pex download from Microsoft Research, but it’s also available in a standalone form.</p><p>Moles is still very much a product with some rough edges.&#160; I’ve had moles randomly stop working with the only fix being an un/reinstall at times.</p><p>Now the good thing about Moles is that it can replace the method call for anything you want.&#160; No limitations at all, however the way it does it is to inspect the assembly you want to mock and then it generates a separate buddy library that provides a way to mock out or stub the method calls you are interested in.&#160; It’s fine when working with things like mscorlib or other assemblies that don’t really change, but if you’re applying it to your own libraries and they change method signatures regularly then you will need to regenerate the moles assemblies each time which is a pain.</p><p>The following code is using the Moles.Xunit extension to run the tests you can’t just run the tests via TestDriven.Net like you can with Isolator – you need to call the tests via the Moles TestRunner.&#160; I use a batch file as follows to help with this:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:6e24aa86-cf4c-442b-99b0-4c2f7bbc57a3" class="wlWriterEditableSmartContent"><pre class="brush: xml;">cd c:\MyCode\bin\debug<br />"C:\Program Files (x86)\Microsoft Moles\bin\moles.runner.x86.exe" Monkeys.Moles.Tests.dll /runner:c:\path\xunit-1.5\xunit.console.x86.exe /x86 <br />pause<br /></pre></div><p>You’ll also need to update assemblyinfo.cs to include attributes that tells Moles which methods you are using like so:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:6c78ca6f-c381-4740-a063-edbadfa66214" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[assembly: MoledType(typeof(System.DateTime))]<br />[assembly: MoledType(typeof(System.Console))]<br /></pre></div><p>And once that’s in place finally you can write a test as follows:</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:d0ee6493-bc9a-442d-94a7-41aee835e4a4" class="wlWriterEditableSmartContent"><pre class="brush: c#;">[Fact]<br />[Moled]<br />public void Replace_current_time()<br />{<br /> MDateTime.NowGet = () =&gt; dateToUse;<br /> Assert.Equal(dateToUse, DateTime.Now);<br />}<br /><br />[Fact]<br />[Moled]<br />public void Monkey_should_be_awake_for_cleaning_at_eight_am()<br />{<br /> MDateTime.NowGet = () =&gt; dateToUse;<br /> var monkey = Substitute.For&lt;IMonkey&gt;();<br /> monkey.CurrentFleaCount().Returns(20);<br /> monkey.IsAwake(Arg.Is(dateToUse)).Returns(true);<br /><br /> var keeper = new ZooKeeper();<br /> keeper.AssignedMonkey = monkey;<br /><br /> keeper.CleanMonkey();<br /><br /> monkey.Received().Clean();<br />}</pre></div><p>So here you may notice that we have an extra attribute on our test method to indicate that this test method uses Moles.&#160; In addition we provide a lambda to MDateTime.NowGet instead of DateTime.Now.&#160; This is the method in the buddy assembly that gets called when DateTime.Now is referenced.&#160; Also, the method naming for Moled types gets a bit funny.&#160; Methods are named based on the method you are mocking and then either a list of types based on the method being called or a Get/Set for properties.&#160; It works, but it’s a little clunky.</p><h3>Conclusion</h3><p>So, my preference here from a syntax viewpoint is the Isolator syntax by far, though the fact that it can’t get to everything in the BCL (such as Console.WriteLine) and that it is a commercial product takes the shine off a little.&#160; On the flip side I like the power of Moles but it’s very clunky to work with, breaks easily and is a pain to use when the target assembly changes a lot and the price and power doesn’t offset this problem.</p><h3>That’s All Folks</h3><p>And that, my friends, is that for this series.</p><p>I hope you’ve enjoyed it and have a good idea of what the various frameworks are capable of.&#160; If you haven’t already guessed, my new favourite framework is <a href="http://nsubstitute.github.com/" target="_blank">NSubstitute</a>.&#160; If you haven’t already, go give it a try and see what you think and give feedback to the guys that wrote it on the <a href="http://groups.google.com/group/nsubstitute" target="_blank">NSubstitute mailing list</a>.</p><p>Happy testing!</p><p>&nbsp;</p><p>Other posts in this series:<ul><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-1-basics.html">1: The Basics</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-2-properties.html">2: Properties</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-3-interactions.html">3: Interactions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-4-parameter.html">4: Parameter Constraints</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-5-repetitions.html">5: Repetitions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-6-multiple.html">6: Multiple Calls</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-7-exceptions.html">7: Exceptions</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-8-recursive.html">8: Recursive Mocks</a></li><li><a href="http://www.richard-banks.org/2010/07/mocking-comparison-part-9-functions.html">9: Functions</a></li><li><a href="http://www.richard-banks.org/2010/08/mocking-comparison-part-10-events.html">10: Events</a></li><li><a href="http://www.richard-banks.org/2010/08/mocking-comparison-part-11-multiple.html">11: Multiple Interfaces</a></li></ul></p>
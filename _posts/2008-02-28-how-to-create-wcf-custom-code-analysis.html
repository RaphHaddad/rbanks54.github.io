---
layout: post
title: How To Create a WCF Custom Code Analysis Rule for Visual Studio
date: '2008-02-28T16:11:00.001+11:00'
author: Richard Banks
tags:
- readify
- ".net"
- development
modified_time: '2008-02-28T16:11:26.450+11:00'
thumbnail: http://lh5.google.com/rbanks54/R8ZCYBnmeEI/AAAAAAAAAP4/-kkm-yr_2_A/s72-c/fxcop2_thumb3
blogger_id: tag:blogger.com,1999:blog-13321238.post-6555199373945957711
blogger_orig_url: http://www.richard-banks.org/2008/02/how-to-create-wcf-custom-code-analysis.html
---

<p>As most people know Visual Studio incorporates the FxCop static code analysis tool so you can perform static code analysis and check that your application follows good coding standards and doesn't contain nasty little surprises like forgetting to dispose of IDisposable objects, etc.</p> <p>Recently I was doing some work with WCF and wanted to check that all methods with an OperationContract attribute had a FaultContract specified as well.&nbsp; Unfortunately this isn't a rule that's part of the default code analysis rules, so I needed to create a Custom Code Analysis rule.&nbsp; Unfortunately most of the samples on custom FxCop rules all seem to be based around doing spell checking or some other such frivolous checks, so hopefully this is something a little meatier for you to get into.</p> <p><em>NOTE: The following "how to" is done with Visual Studio 2008.&nbsp; Specific variations for VS2005 are shown in italics.</em></p> <p>Also, a lot of this information was gathered from those who've gone before me.&nbsp; Namely <a href="http://bordecal.mvps.org/nicole/fxcop/customruledetails.htm" target="_blank">Nicole Calinoiu</a>, <a href="http://www.biasecurities.com/blogs/jim/archive/2004/12/29/818.aspx" target="_blank">James Guerts</a>, <a href="http://www.binarycoder.net/fxcop/html/index.html" target="_blank">Jason Kresowaty</a> and others.&nbsp; Many thanks to them for doing the hard yards and figuring out how things fit together.</p> <h3>Step 0 - We Need Something to Analyse</h3> <p>First, let's create a WCF project so we've got something we can run the rules against.</p> <p>Create a new WCF Service Library project (.NET 3.0) - by default it will be called WcfServiceLibrary1 and will have a default service contract as shown:</p><pre class="codeblock">    <span style="color: rgb(0,128,0)">// NOTE: If you change the interface name "IService1" here, you must also update the reference to "IService1" in App.config.<br /></span>    [<span style="color: rgb(43,145,175)">ServiceContract</span>]<br />    <span style="color: rgb(0,0,255)">public</span> <span style="color: rgb(0,0,255)">interface</span> <span style="color: rgb(43,145,175)">IService1<br /></span>    {<br />        [<span style="color: rgb(43,145,175)">OperationContract</span>]<br />        <span style="color: rgb(0,0,255)">string</span> GetData(<span style="color: rgb(0,0,255)">int</span> value);<br /><br />        [<span style="color: rgb(43,145,175)">OperationContract</span>]<br />        <span style="color: rgb(43,145,175)">CompositeType</span> GetDataUsingDataContract(<span style="color: rgb(43,145,175)">CompositeType</span> composite);<br /><br />        <span style="color: rgb(0,128,0)">// TODO: Add your service operations here<br /></span>    } </pre><br /><p>As you can see the methods marked as OperationContract do not have any FaultContract attributes specified.</p><br /><p>We're going to detect this with our custom rule because we want to make sure that the faults are explicitly declared.</p><br /><h3>Step 1 - Create a Class Library Project</h3><br /><p>Create a new class library project - we'll call it MyFxCopRules.&nbsp; It can be a normal .NET 2.0 project.</p><br /><h3>Step 2 - Add References and Create a custom rule base class</h3><br /><p>You'll need to add 2 references to the MyFxCopRules project.&nbsp; One for <strong>FxCopSdk.dll</strong> and one for <strong>Microsoft.Cci.dll. </strong>Both DLL's can be found in %ProgramFiles%\Microsoft Visual Studio 9.0\Team Tools\Static Analysis Tools\FxCop\</p><br /><p><a href="http://lh6.google.com/rbanks54/R8ZCXRnmeDI/AAAAAAAAAPw/bZ1BosBGGMs/fxcop25"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="183" alt="fxcop2" src="http://lh5.google.com/rbanks54/R8ZCYBnmeEI/AAAAAAAAAP4/-kkm-yr_2_A/fxcop2_thumb3" width="205" border="0"></a> </p><br /><p>For FxCop to determine which classes in an assembly represent custom rules it will look for classes that implement the IIntrospectionRule interface.&nbsp; When working with managed code you'll also need to implement the IManagedCodeRule interface.&nbsp;&nbsp; Fortunately there is an abstract base class that implements these interfaces already - the BaseIntrospectionRule class.</p><br /><p>So let's make Class1.cs a base class for all the custom rule we want to define.</p><br /><p>Add a reference to the Microsoft.FxCop.Sdk namespace, change the name of the class to MyBaseRule and inherit from BaseIntrospectionRule as follows:</p><pre class="codeblock"><span style="color: rgb(0,0,255)">using</span> Microsoft.FxCop.Sdk;<br /><br /><span style="color: rgb(0,0,255)">namespace</span> MyFxCopRules<br />{<br />    <span style="color: rgb(0,0,255)">public abstract class</span> <span style="color: rgb(43,145,175)">MyBaseRule</span> : <span style="color: rgb(43,145,175)">BaseIntrospectionRule<br /></span>    {<br />    }<br />}</pre><br /><p></p><br /><p><em>[VS2005] In the using directives add Microsoft.FxCop.Sdk.Introspection</em></p><br /><p>When creating a rule we need to tell the Introspection engine what the name of the rule is, the rule set it belongs to and the assembly it is declared in.&nbsp; We could do this once per rule, or we can do it by adding the following constructor to our base rule class</p><pre class="codeblock">        <span style="color: rgb(0,0,255)">protected</span> MyBaseRule(<span style="color: rgb(0,0,255)">string</span> name)<br />            : <span style="color: rgb(0,0,255)">base</span>(name, <span style="color: rgb(163,21,21)">"MyFxCopRules.Rules"</span>, <span style="color: rgb(0,0,255)">typeof</span>(<span style="color: rgb(43,145,175)">MyBaseRule</span>).Assembly)<br />        {<br />        } </pre><br /><h3>Step 3 - Add a Folder And A Rule</h3><br /><p>Now we're going to create our rule.&nbsp; Let's start by adding a folder to put all future rules in and then create a new class for our custom rule.&nbsp; Add a folder to the project called "Rules" and a class called "EnsureFaultContractsAreDeclared".&nbsp; It's good practice to name classes according to the rule they are validating.</p><br /><p>You should now have a project as follows:</p><br /><p><a href="http://lh5.google.com/rbanks54/R8ZCZBnmeFI/AAAAAAAAAQA/x1O3yoZVup0/fxcop3%5B2%5D"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="217" alt="fxcop3" src="http://lh4.google.com/rbanks54/R8ZCZxnmeGI/AAAAAAAAAQI/qaWDPCAeHLw/fxcop3_thumb" width="206" border="0"></a> </p><br /><h3>Step 4 - Define The Rule</h3><br /><p>OK! Now to the meat of it.&nbsp; Let's define the rule itself.</p><br /><p>First, we need to add references to the Microsoft.FxCop.Sdk and Microsoft.Cci namespaces.&nbsp; Next we need to make our class inherit from the base class we defined earlier and pass the name of our rule to the base class constructor so that FxCop knows what our rule is called.&nbsp; It's easy enough to do and you code should look like this:</p><pre class="codeblock"><span style="color: rgb(0,0,255)">using</span> Microsoft.FxCop.Sdk;<br /><br /><span style="color: rgb(0,0,255)">namespace</span> MyFxCopRules.Rules<br />{<br />    <span style="color: rgb(0,0,255)">public class</span> <span style="color: rgb(43,145,175)">EnsureFaultContractsAreDeclared</span> : <span style="color: rgb(43,145,175)">MyBaseRule<br /></span>    {<br />        <span style="color: rgb(0,0,255)">public</span> EnsureFaultContractsAreDeclared()<br />            : <span style="color: rgb(0,0,255)">base</span>(<span style="color: rgb(163,21,21)">"EnsureFaultContractsAreDeclared"</span>)<br />        {<br />        }<br />    }<br />}</pre><br /><p><em>[VS2005] In the using directives add Microsoft.FxCop.Sdk.Introspection and Microsoft.Cci</em></p><br /><p>Of course, this rule is pretty much useless right now as it doesn't actually do anything.</p><br /><p>What we need to do is implement a Check() method.&nbsp; There are various Check() methods that the BaseIntrospectionRule class exposes and these methods are called by the introspection engine each time it visits a code element.&nbsp; When the Check() method runs it should report back any problems it finds in a ProblemCollection.&nbsp; Obviously if there are no items in the collection it means the rule evaluated successfully.</p><br /><p>Because the rule we are writing is going to be checking that method level attributes are correctly defined we will implement the Check(Member member) method.</p><pre class="codeblock">        <span style="color: rgb(0,0,255)">public</span> <span style="color: rgb(0,0,255)">override</span> <span style="color: rgb(43,145,175)">ProblemCollection</span> Check(<span style="color: rgb(43,145,175)">Member</span> member)<br />        {<br />            <span style="color: rgb(0,0,255)">if</span> (VerifyAttributes(member.Attributes))<br />            {<br />                <span style="color: rgb(0,0,255)">this</span>.Problems.Add(<span style="color: rgb(0,0,255)">new</span> <span style="color: rgb(43,145,175)">Problem</span>(<span style="color: rgb(0,0,255)">this</span>.GetResolution(member), member));<br />            }<br />            <span style="color: rgb(0,0,255)">return</span> <span style="color: rgb(0,0,255)">this</span>.Problems;<br />        }<br /><br />        <span style="color: rgb(0,0,255)">private</span> <span style="color: rgb(0,0,255)">static</span> <span style="color: rgb(0,0,255)">bool</span> VerifyAttributes(<span style="color: rgb(43,145,175)">AttributeNodeCollection</span> attributes)<br />        {<br />            <span style="color: rgb(0,0,255)">bool</span> isOperationContract = <span style="color: rgb(0,0,255)">false</span>;<br />            <span style="color: rgb(0,0,255)">bool</span> hasFaultContract = <span style="color: rgb(0,0,255)">false</span>;<br />            <span style="color: rgb(0,0,255)">foreach</span> (<span style="color: rgb(43,145,175)">AttributeNode</span> attribute <span style="color: rgb(0,0,255)">in</span> attributes)<br />            {<br />                <span style="color: rgb(0,0,255)">if</span> (attribute.Type.FullName == <span style="color: rgb(163,21,21)">"System.ServiceModel.OperationContractAttribute"</span>)<br />                    isOperationContract = <span style="color: rgb(0,0,255)">true</span>;<br />                <span style="color: rgb(0,0,255)">if</span> (attribute.Type.FullName == <span style="color: rgb(163,21,21)">"System.ServiceModel.FaultContractAttribute"</span>)<br />                    hasFaultContract = <span style="color: rgb(0,0,255)">true</span>;<br />            }<br />            <span style="color: rgb(0,0,255)">if</span> (isOperationContract)<br />                <span style="color: rgb(0,0,255)">return</span> !hasFaultContract;<br />            <span style="color: rgb(0,0,255)">return</span> <span style="color: rgb(0,0,255)">false</span>;<br />        }</pre><br /><p><em>[VS2005] Use the type AttributeList instead of AttributeNodeCollection for the VerifyAttributes parameter</em></p><br /><p><em>[VS2005] Use RuleUtilities.Format(member) instead of member in the GetResolution() call</em></p><br /><p>So, what happens when FxCop evaluates this rule?</p><br /><p>1. The Check() method gets called and the current Member (method or property) being checked is passed in.</p><br /><p>2. We take the collection of Attributes that the member has associated with it and pass them to the VerifyAttributes helper method.</p><br /><p>3. VerifyAttributes does a simple scan through the Attribute collection looking for any attributes of the appropriate type.&nbsp; If an [OperationContract()] is found but we don't find a [FaultContract()] we return false to true to the Check method to indicate we have a problem.</p><br /><p>4. Back up in the Check method we create a new Problem and add it to the ProblemCollection before returning control back to FxCop.</p><br /><h3>Step 5 - Define a Rules.XML file</h3><br /><p>We're not quite done yet.&nbsp; If we were to take this code, compile it and then try to use it we would see a rule group appear in Visual Studio, but we wouldn't see any rules in the group.</p><br /><p>This is because we haven't yet created an XML file that defines the rule behaviours when problems are found.&nbsp; The code determines if a problem exists, the XML file determines what do show when a problem is found.</p><br /><p>Go and add a Rules.XML file to the project and ensure that the Build Action is set to "Embedded Resource" as shown</p><br /><p><a href="http://lh6.google.com/rbanks54/R8ZCaRnmeHI/AAAAAAAAAQQ/_DNeLsthSyw/fxcop4%5B2%5D"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="175" alt="fxcop4" src="http://lh4.google.com/rbanks54/R8ZCaxnmeII/AAAAAAAAAQY/V_KwKFiJOaQ/fxcop4_thumb" width="244" border="0"></a> </p><br /><p>Inside the file add the following XML</p><pre class="codeblock"><span style="color: rgb(0,0,255)">&lt;?</span><span style="color: rgb(163,21,21)">xml</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">version</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">1.0</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">encoding</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">utf-8</span>"<span style="color: rgb(0,0,255)">?&gt;<br />&lt;</span><span style="color: rgb(163,21,21)">Rules</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">FriendlyName</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">My Custom Rules</span>"<span style="color: rgb(0,0,255)">&gt;<br />    &lt;</span><span style="color: rgb(163,21,21)">Rule</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">TypeName</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">EnsureFaultContractsAreDeclared</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Category</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">MyRules.Usage</span>"<span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">CheckId</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">MU0001</span>"<span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Name</span><span style="color: rgb(0,0,255)">&gt;</span>Supply Fault Contracts for all WCF Operations<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">Name</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">FixCategories</span><span style="color: rgb(0,0,255)">&gt;</span>Breaking<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">FixCategories</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">MessageLevel</span><span style="color: rgb(0,0,255)"> </span><span style="color: rgb(255,0,0)">Certainty</span><span style="color: rgb(0,0,255)">=</span>"<span style="color: rgb(0,0,255)">95</span>"<span style="color: rgb(0,0,255)">&gt;</span>Warning<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">MessageLevel</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Resolution</span><span style="color: rgb(0,0,255)">&gt;</span>WCF Operation Contracts need to have a fault contract defined using the [FaultContract()] attribute<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">Resolution</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Description</span><span style="color: rgb(0,0,255)">&gt;</span>Fault Contracts need to be applied to all WCF services<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">Description</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Owner</span><span style="color: rgb(0,0,255)">&gt;</span>Richard Banks<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">Owner</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Email</span><span style="color: rgb(0,0,255)">&gt;&lt;/</span><span style="color: rgb(163,21,21)">Email</span><span style="color: rgb(0,0,255)">&gt;<br />        &lt;</span><span style="color: rgb(163,21,21)">Url</span><span style="color: rgb(0,0,255)">&gt;</span>http://richardsbraindump.blogspot.com<span style="color: rgb(0,0,255)">&lt;/</span><span style="color: rgb(163,21,21)">Url</span><span style="color: rgb(0,0,255)">&gt;<br />    &lt;/</span><span style="color: rgb(163,21,21)">Rule</span><span style="color: rgb(0,0,255)">&gt;<br />&lt;/</span><span style="color: rgb(163,21,21)">Rules</span><span style="color: rgb(0,0,255)">&gt;</span></pre><br /><p> Hopefully the properties are all obvious enough.&nbsp; If you have problems check that the TypeName doesn't have any spelling mistakes in it. </p><br /><h3>Step 6 - Deployment</h3><br /><p>Now compile the project and make sure everything is OK.&nbsp; Then close Visual Studio 2008.</p><br /><p>Copy your custom FxCop rules assembly from your output folder into the Visual Studio rules folder - typically C:\Program Files\Microsoft Visual Studio 9.0\Team Tools\Static Analysis Tools\FxCop\Rules</p><br /><p>Restart Visual Studio and open the solution again.&nbsp; If you now go to the properties page for the WcfServiceLibrary1 project you should see something like the following:</p><br /><p><a href="http://lh3.google.com/rbanks54/R8ZCbhnmeJI/AAAAAAAAAQg/33GXorXDD3c/fxcop5%5B3%5D"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="234" alt="fxcop5" src="http://lh5.google.com/rbanks54/R8ZCcBnmeKI/AAAAAAAAAQo/I16F8J4RwpQ/fxcop5_thumb%5B1%5D" width="409" border="0"></a> </p><br /><p>If you then run Code Analysis for the project (Build-&gt;Run Code Analysis...) you should see the following in the Error List window:</p><br /><p><a href="http://lh5.google.com/rbanks54/R8ZCdBnmeLI/AAAAAAAAAQw/Klo2K3Y1VzU/fxcop6%5B3%5D"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="169" alt="fxcop6" src="http://lh5.google.com/rbanks54/R8ZCeBnmeMI/AAAAAAAAAQ4/I7of5VNfeO0/fxcop6_thumb%5B1%5D" width="644" border="0"></a> </p><br /><p>You're all done!&nbsp; You&nbsp; now have a working rule that does something other than check spelling :-)</p><br /><p>You can double check that the rule works properly by adding [FaultContract(null)] to one of the operation contracts methods and seeing that when you re-run analysis that there is one less MU0001 warning.</p><br /><p>P.S. If you're into FxCop then you'll probably want to add some rule suppressions to your rule classes as well as the code for the custom rule will violate a few of the standard FxCop rules (CA1014 &amp; CA2210).</p>  
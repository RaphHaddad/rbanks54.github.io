---
layout: post
title: Secure Unit Testing and Signed Assemblies
date: '2007-12-03T08:05:00.001+11:00'
author: Richard Banks
tags:
- readify
- ".net"
- testing
- development
modified_time: '2007-12-03T08:08:45.623+11:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-1363929096418632828
blogger_orig_url: http://www.richard-banks.org/2007/12/secure-unit-testing-and-signed.html
---

<p>When looking at examples for unit testing you'll typically see that all the methods for the class under test are public.&nbsp; Either that, or that the unit tests themselves are in the same class assembly as the class under test.  <p>The first pattern (all public methods) represents a problem when you don't want every method to be public, especially if you need to distribute your assembly far and wide where it will live outside of your control.&nbsp; All those public methods are a great way for people to attack or misuse your application.  <p>The second method (embed unit tests) is probably worse, since you're then not only distributing your code, but all your tests as well.&nbsp; All those unit tests themselves can be used as an attack vector for your application.  <p>Does this mean that if you secure your methods using the internal attribute that you can't unit test them?&nbsp; Not at all!  <p>What you need to do is give permissions to allow the unit test assembly to see the internal methods of your classes using the InternalsVisibleTo assembly attribute (.NET 2.0+).  <p>Let's say we have an assembly called BusinessLogic.DLL with a class MyClass as follows:<pre class="codeblock"><span style="color: rgb(0,0,255)">internal</span> <span style="color: rgb(0,0,255)">class</span> MyClass<br />{<br />    <span style="color: rgb(0,0,255)">internal int</span> MyMethod()<br />    {<br />        <span style="color: rgb(0,128,0)">//... Do Stuff<br /></span>    }<br />}</pre><p>And we now want to create a unit test for this class in a separate BusinessLogicTests.DLL like so:<pre class="codeblock">[TestFixture()]<br /><span style="color: rgb(0,0,255)">public</span> <span style="color: rgb(0,0,255)">class</span> MyClassTests<br />{<br />    [TestMethod()]<br />    <span style="color: rgb(0,0,255)">public</span> <span style="color: rgb(0,0,255)">void</span> TestMyMethod()<br />    {<br />        MyClass myClass = <span style="color: rgb(0,0,255)">new</span> MyClass();<br />        Assert.AreEqual(myClass.MyMethod(), 0);<br />    }<br />}<br /></pre><p>Then we would have a problem, as MyClass is not visible to MyClassTests because of the internal permission.</p><br /><p>To resolve this we can get the BusinessLogic.DLL to explicitly give permissions to the BusinessLogicTests.DLL to see it's internal classes and methods.</p><br /><p>By adding the following to the assemblyinfo.cs file in BusinessLogic.DLL</p><pre class="codeblock">[assembly: <span style="color: rgb(43,145,175)">InternalsVisibleTo</span>(<span style="color: rgb(163,21,21)">"BusinessLogicTests"</span>)]</pre><br /><p>We explicitly give permissions for the BusinessLogicTests assembly to see the internal members which now gives us the ability to write our unit tests as we wish without exposing our methods and classes for the whole world to see.</p><br /><h4>Signed Assemblies</h4><br /><p>There is one wrinkle though.&nbsp; If we need to sign the BusinessLogic.DLL assembly then we also need to sign the BusinessLogicTests.DLL so that we can reference the assembly under test at run time (or we get runtime security errors).&nbsp; However once we do this the InternalsVisibleTo line shown above will no longer work, as we need to include the public key of the unit test assembly. <br /><p>So, how do we get the public key for our unit tests? Assuming your strong name key for the unit tests is called UnitTestKey.snk then you can do the following from the command prompt: <br /><p>1. Run sn.exe -p UnitTestKey.snk UnitTestKey.PublicKey.&nbsp; This will extract the public key to a file with the .PublicKey extension. <br /><p>2. Run sn.exe -tp UnitTestKey.PublicKey.&nbsp; This will display the public key for you, which will be a big long string of hexadecimal.&nbsp; Copy this key.&nbsp; <p>3. Paste it into in your code (and remove the line breaks) as</p><pre class="codeblock">[assembly: <span style="color: rgb(43,145,175)">InternalsVisibleTo</span>(<span style="color: rgb(163,21,21)">"BusinessLogicTests, PublicKey=&lt;&lt;PASTE-YOUR-PUBLIC-KEY-HERE&gt;&gt;"</span>)]</pre><p>Once you've done this your code should look like this: <pre class="codeblock">[assembly: <span style="color: rgb(43,145,175)">InternalsVisibleTo</span>(<span style="color: rgb(163,21,21)">"BusinessLogicTests, PublicKey=01440204048000009400000006020000002400005253416100040000f1000100971adbbcba6b77844f73323f234c918f421b7472af8e6d61e7e164180f226d0c6592cfad83153a790d10310abc338632208a775d588f7e0302d498a8506f2fcaa78d6c20d5220db75c802309ae8c30d3c7532e8055f55ab122a90bda7aaab82481674a9343eedb1784d1fedf4653c733885412a97fdd88cc89bd3376f870949b"</span>)] <br /></pre><p>After this you should be able to compile and run your unit tests without a problem, and without exposing anything you shouldn't to the outside world.</p>  
---
layout: post
title: Branch per Story Pattern and TFS
date: '2011-02-05T00:10:00.000+11:00'
author: Richard Banks
tags:
- how to
- TFS
- alm
modified_time: '2011-02-05T00:10:59.905+11:00'
thumbnail: http://lh3.ggpht.com/_5dD_rBQSs2o/TUv5pz94OtI/AAAAAAAAA8Q/gBCtfTrIsGk/s72-c/image_thumb%5B3%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-13321238.post-6591776477595923040
blogger_orig_url: http://www.richard-banks.org/2011/02/branch-per-story-pattern-and-tfs.html
---

<p>The TFS branching guide is a very detailed run through of the various situations and scenarios under which branching can be performed and the different strategies that exist, however because the guide covers so many scenarios it’s difficult for some people to know what approach they should follow, and when they look at some of the advanced diagrams they freak out at the complexity.</p>  <p>For this post I’m going to keep it simple and just show one approach, the one that I feel is best for agile teams implementing using user stories.&#160; It’s effectively the feature branch approach, and I’ve been tempted not to write this post, however I find that that feature-branch approach can be a little confusing for some people.&#160; “What is a feature?” “Is it multiple stories?” “Is it an epic?” “Is it a bug fix?” “Should a feature live across multiple sprints?” These are all questions I hear and it’s probably because the terminology is a little too generic and becomes open to interpretation and thus misunderstanding.&#160; So, let’s make it easy and use Agile terminology.</p>  <h2>Why Story Branches</h2>  <p>So before we get into it, what exactly is wrong with working in trunk or using a branch per sprint approach? If you can make it work then there is nothing wrong with that approach, but it does come with some with hidden dangers.</p>  <p>Consider the following situation.&#160; A team accepts 3 product backlog items for a sprint and only completes 2 of those items.&#160; The third story was in progress when the sprint concluded but was far from complete and the team now has a section of unfinished code in their code base.</p>  <p>What should the team do with that unfinished code? Should they go back and comment it out or delete it?&#160; Maybe, but how will they be sure they got it all?&#160; What if some of the changes they were making affected the system architecture and those changes had been used in the implementation of the other two stories? What if the code was also merged to another branch in preparation for a release?</p>  <p>What if they take a different approach and try wrapping all changes in if-blocks during development to try and isolate the changes?&#160; Sure, this can work.&#160; But again it has challenges.&#160; The team needs to maintain a set of variables or pre-processor tokens related to each item that are used to decide if a feature is available or not.&#160; There’s also going to be a large number of if statements that will add noise to the code and in a complex system you can easily imagine how out of control this could get.</p>  <p>What if they just ignore these challenges (or forget the code) and leave the unfinished code as is? At best they have code that is unused and simply adds bloat to the system, at worst it results in the system being released with broken functionality and open security attack vectors that have never been checked or tested.</p>  <p>If we also remind ourselves that sprints should produce production ready, potentially releasable increments of the system, then we really, really don’t want to have work in progress code in the system at sprint conclusion.</p>  <p>For all of these reasons we should ensure our development of a feature is isolated from the rest of the development team and only made generally available when complete and ready for integration testing. </p>  <p>There’s an interesting side effect to taking this approach.&#160; If we develop features in isolation and consider <a href="http://en.wikipedia.org/wiki/Conway's_Law" target="_blank">Conway’s law</a> which when paraphrased says that system architectures reflect the way the organisation communicates, then by nature the systems we develop using a branch per story model will likely be architected and designed as componentised and modular systems, mirroring the development approach we are using.</p>  <h2>Downsides</h2>  <p>What are the downsides, then? Surely the administration overhead goes up and chances of screwing up merges increases, and yes, there is an element of that, but it isn’t as bad as you think.</p>  <p>Administration time goes up because we now have to remember to create a branch, and we have to remember to switch branches when we work on different stories in the same sprint.&#160; Is this really an issue though? Maybe it is.&#160; However maybe it’s a hidden blessing in disguise.&#160; When working in an agile manner we want to minimise wasted effort and keep our work in progress as low as we can. We know that the costs of multi-tasking, working on different stories at the same time, means we’re go slower overall than if we just work on one story at a time because of the mental context switch and yet the temptation to multi-task is high, especially if the stories we work on are somewhat boring.</p>  <p>By following a branch per story strategy we discourage ourselves from multitasking since the simple annoyance of switching to a solution file on a different branch gives us a natural prevention mechanism.&#160; Note that this annoyance doesn’t work with DVCS systems like git and mercurial since branch switching is very quick and easy, but in TFS, SubVersion and similar branches are represented as folders and switching means swapping folders, and thus closing and re-opening the solution.</p>  <p>What about merging? Branching is easy but a great deal of pain can be had in the merging of branches.&#160; This pain is most often encountered when the two branches have diverged significantly.&#160; However, in a branch-per-story model most branches are short lived and thus merging fairly straightforward.&#160; It doesn’t mean merge conflicts can’t occur, just that the merges are likely to have small amounts of conflicts.</p>  <h2>Visual Branching Model</h2>  <p>So let’s have a look at what we’re doing with the branching model.&#160; For each story in the sprint we work on we’re create a story branch by branching the main integration branch.</p>  <p>Let’s say the team picks up three stories for the sprint.&#160; We create the story branches and the team commences work: </p>  <p><a href="http://lh3.ggpht.com/_5dD_rBQSs2o/TUv5oqPlrFI/AAAAAAAAA8M/qeu1-03VMVE/s1600-h/image%5B5%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/_5dD_rBQSs2o/TUv5pz94OtI/AAAAAAAAA8Q/gBCtfTrIsGk/image_thumb%5B3%5D.png?imgmax=800" width="480" height="233" /></a></p>  <p>Let’s say Story 1 gets completed first.&#160; The code for story 1 is merged back to the integration branch, the integration code is checked and verified and when all the tasks for the story are complete the branch is killed off.</p>  <p>Next, Story 2 is completed so the developers pull from the integration branch, merge the changes, confirm things are OK locally, then push their changes back to the integration branch.&#160; Again, the developers check the code in the integration branch is OK, and when it is the story 2 branch is killed off.</p>  <p>Finally Story 3 is code complete.&#160; Again, the developers pull the branch code down to their story branch, do the merge and make sure it’s OK.&#160; When it looks good they push their changes back to the integration branch, make sure the integration branch is OK and kill of the Story 3 branch.</p>  <p>Pretty simple process, right?</p>  <h2>Doing it with TFS</h2>  <p>So, enough with the explanations let’s see how we do this with TFS.</p>  <p>Creating branches is easy enough, but how do you name the branches?&#160; We don’t want to try and embed the story name in the branch name since that will increase folder length and makes it far more likely that we’ll hit the file path length limit (yes, there is one and it’s smaller than you think).</p>  <p>The strategy I prefer is simple.&#160; Because we are using TFS and stories are just TFS work items, I like to use the story number as the branch name.&#160; Here’s an example:</p>  <p><a href="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv5rKgAfjI/AAAAAAAAA8U/QV3ksgSjMh0/s1600-h/image%5B10%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv5sMKELFI/AAAAAAAAA8Y/GvoOv48HFl0/image_thumb%5B6%5D.png?imgmax=800" width="176" height="117" /></a></p>  <p>Now let’s do some work on story 2639 (aka “Make this system more awesome!”) and check it in. Now we need to make sure that we’re on par with the integration branch by doing a merge.&#160; We simply right click the Integration branch and select Merge:</p>  <p><a href="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv5tHqpXjI/AAAAAAAAA8c/Mv0GgVUw5ck/s1600-h/image%5B15%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/_5dD_rBQSs2o/TUv5uLv7PEI/AAAAAAAAA8g/h5LTBgAqCaA/image_thumb%5B9%5D.png?imgmax=800" width="434" height="102" /></a></p>  <p>Then merge to the appropriate story branch</p>  <p><a href="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv5u-oKt5I/AAAAAAAAA8k/7zwW0jYu24c/s1600-h/image%5B19%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv5wFpFkWI/AAAAAAAAA8o/SdbWd_83JJk/image_thumb%5B11%5D.png?imgmax=800" width="484" height="270" /></a></p>  <p>Select the latest version to make sure we’re current and hit the button</p>  <p><a href="http://lh3.ggpht.com/_5dD_rBQSs2o/TUv5xWNyzfI/AAAAAAAAA8s/cO-z0J7gyTo/s1600-h/image%5B23%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv5yUu3kyI/AAAAAAAAA8w/PKC8bDR2QTg/image_thumb%5B13%5D.png?imgmax=800" width="345" height="144" /></a></p>  <p>It appears there are no changes to merge.&#160; Excellent, we’re current.</p>  <p><a href="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv5zDlIvFI/AAAAAAAAA80/to0up-b7mtk/s1600-h/image%5B27%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_5dD_rBQSs2o/TUv51KXmygI/AAAAAAAAA84/IyOUXBHu1Ws/image_thumb%5B15%5D.png?imgmax=800" width="240" height="139" /></a></p>  <p>So now we merge our changes from the story to the integration branch (same process, just start by right-clicking the story branch).&#160; Also, don’t forget that merges are made as local changes and still have to be committed, so add a check in comment and do just that.</p>  <p>Wait for the integration build to pass and check the acceptance tests pass to let us know that the story is complete.&#160; Once it is we can now kill the story branch.&#160; To do this, simply right click the branch in source control explorer and select delete!</p>  <p><a href="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv52Me91BI/AAAAAAAAA88/iYIX3jTeoPs/s1600-h/image%5B36%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv53E-kjsI/AAAAAAAAA9A/IleannrA734/image_thumb%5B20%5D.png?imgmax=800" width="348" height="190" /></a></p>  <p>Again the delete’s are pending changes until we check them in.&#160; So again, add a comment and check in the changes.</p>  <p>Our branch hierarchy now changes from this:</p>  <p><a href="http://lh3.ggpht.com/_5dD_rBQSs2o/TUv53x3gljI/AAAAAAAAA9E/SMhJd5ik9Kc/s1600-h/image%5B42%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv55AdxJPI/AAAAAAAAA9I/Hld8DrTzLAY/image_thumb%5B24%5D.png?imgmax=800" width="480" height="114" /></a></p>  <p>to this:</p>  <p><a href="http://lh4.ggpht.com/_5dD_rBQSs2o/TUv557Q9_hI/AAAAAAAAA9M/pIJXr4t5eUc/s1600-h/image%5B47%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_5dD_rBQSs2o/TUv57rHrbjI/AAAAAAAAA9Q/3NOwos6h4lg/image_thumb%5B27%5D.png?imgmax=800" width="433" height="139" /></a></p>  <p>Nice and simple.&#160; And not a lot of overhead.</p>  <p>As for the other stories we follow the exact same procedure when they are complete:</p>  <p>1. Make the changes needed for the story in the story branch   <br />2. Pull and merge changes from the integration branch into the story branch    <br />3. Deal with any merge conflicts    <br />4. Check that the story is still OK    <br />5. Push and merge the changes back up to the integration branch.&#160; You shouldn’t have any merge conflicts for this merge.    <br />6. Check that the Continuous Integration build passes    <br />7. Run any other tests on the integrated code as required.</p>  <p>And we’re done!</p>  <p>When all stories are complete in the sprint there should be no story branches left. The only time this won’t be true is when the team finished the sprint with incomplete stories.</p>  <h2>What About Bugs?</h2>  <p>Bugs in an agile team are just the same as stories.&#160; Create a bug fix branch each time you need to fix a bug just the same as we do for stories.</p>  <p>About the only time you might not do this is when you are doing really simple bug fixes such as spelling mistakes where the changes are just cosmetic and there are no real logic or functional changes.</p>  <h2>What About the Build Server?</h2>  <p>So a question you may have is what do we do with builds and the build server? Answer: it’s up to you.&#160; Given how short lived the story branches are likely to be it’s probably not worth creating build definitions for each story, but again, it’s completely up to you. Regardless of wether you have a build per story or not, you should have a continuous integration build tied to the integration branch.&#160; When each story is complete and merged back to the integration branch a build should be triggered that compiles the code, runs all the unit tests and so forth to confirm that the code in the integration branch is OK and nothing went wrong during the merge.</p>
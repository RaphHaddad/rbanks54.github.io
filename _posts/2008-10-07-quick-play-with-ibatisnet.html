---
layout: post
title: A Quick Play With IBatis.NET
date: '2008-10-07T15:21:00.002+11:00'
author: Richard Banks
tags:
- database
- readify
- ".net"
- open source
- tools
- development
modified_time: '2008-10-07T15:25:33.457+11:00'
blogger_id: tag:blogger.com,1999:blog-13321238.post-8239866899123760862
blogger_orig_url: http://www.richard-banks.org/2008/10/quick-play-with-ibatisnet.html
---

<p>You may remember a few posts back that I was working with a team trying to use a pure stored procedure approach to access a database, and trying to do so using an OR/M.  One of the commenters on the post mentioned iBATIS.  Now I always thought <a target="_blank" href="http://ibatis.apache.org/index.html">iBATIS</a> was a competitor to <a target="_blank" href="http://www.hibernate.org/343.html">NHibernate</a>, Linq2SQL, et al. but it's actually a different approach where instead of being a fully blown OR/M it just does simple data mapping of business objects to and from SQL statements and nothing more than that. </p><p>So I decided to have a bit of a play with it and I must say it looks pretty good.  Here's a quick bit of sample code I knocked up to see how it works. </p><p>Assume I have the following sproc:</p><pre class="codeblock"><span style="color: rgb(0, 0, 255);">CREATE PROCEDURE </span>InsertSaleHeader<br />   @Tax <span style="color: rgb(0, 0, 255);">money</span>,<br />   @TotalValue <span style="color: rgb(0, 0, 255);">money</span>,<br />   @SaleNumber <span style="color: rgb(0, 0, 255);">int output<br />AS<br />BEGIN<br /></span>    <span style="color: rgb(0, 0, 255);">SET NOCOUNT ON</span>;<br /><br />   <span style="color: rgb(0, 0, 255);">INSERT INTO </span>[dbo].[SaleHeader]<br />          ([Tax]<br />          ,[TotalValue]<br />          ,[ModifiedDate])<br />    <span style="color: rgb(0, 0, 255);">VALUES<br /></span>           (@Tax,@TotalValue,<span style="color: rgb(0, 0, 255);">GETDATE</span>())<br />    <span style="color: rgb(0, 0, 255);">SET </span>@SaleNumber = <span style="color: rgb(0, 0, 255);">scope_identity</span>()<br />   <br /><span style="color: rgb(0, 0, 255);">END</span></pre><br /><p>It's just a basic insert sproc that updates a modified date on insert and also returns a new identity value for the record we just added using an out parameter.  This is the sort of thing that was a real pain to so with many of the full featured OR/M's.</p><br /><p>I then wrote an integration test (p.s. please forgive my incorrect casing in places):</p><pre class="codeblock"><span style="color: rgb(0, 0, 255);">using</span> IBatisNet.DataMapper;<br /><span style="color: rgb(0, 0, 255);">using</span> SalesDAL.ibatis;<br /><br /><span style="color: rgb(0, 0, 255);">namespace</span> SalesIntegrationTests<br />{<br />   [<span style="color: rgb(43, 145, 175);">TestClass</span>]<br />   <span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">class</span> <span style="color: rgb(43, 145, 175);">ibatisSaleRepositoryTests<br /></span>    {<br />       [<span style="color: rgb(43, 145, 175);">TestMethod</span>]<br />       <span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">void</span> CreateSaleAndGetSalesUsingIBatis()<br />       {<br />           <span style="color: rgb(43, 145, 175);">ISqlMapper</span> mapper = <span style="color: rgb(43, 145, 175);">Mapper</span>.Instance();<br />           <span style="color: rgb(43, 145, 175);">ISaleRepository</span> repository = <span style="color: rgb(0, 0, 255);">new</span> <span style="color: rgb(43, 145, 175);">ibatisSaleRepository</span>(mapper);<br />           <span style="color: rgb(43, 145, 175);">ISale</span> sale = <span style="color: rgb(0, 0, 255);">new</span> SalesTax.<span style="color: rgb(43, 145, 175);">Sale</span>();<br />           sale.Add(<span style="color: rgb(0, 0, 255);">new</span> SalesTax.<span style="color: rgb(43, 145, 175);">SaleLine</span>(1, <span style="color: rgb(163, 21, 21);">"imported box of chocolates"</span>, 10.00m, <span style="color: rgb(0, 0, 255);">true</span>));<br />           <span style="color: rgb(0, 0, 255);">bool</span> result = repository.CreateSale(sale);<br />           <span style="color: rgb(43, 145, 175);">Assert</span>.IsTrue(result);<br />       }<br />   }<br />}</pre><br /><p>This just creates an instance of a sale object and sends it to a sale repository class.  The code for the ibatisSaleRepository is shown below.</p><pre class="codeblock"><span style="color: rgb(0, 0, 255);">namespace</span> SalesDAL.ibatis<br />{<br />   <span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">class</span> <span style="color: rgb(43, 145, 175);">ibatisSaleRepository</span> : <span style="color: rgb(43, 145, 175);">ISaleRepository<br /></span>    {<br />       <span style="color: rgb(0, 0, 255);">private</span> <span style="color: rgb(43, 145, 175);">ISqlMapper</span> mapper;<br /><br />       <span style="color: rgb(0, 0, 255);">public</span> ibatisSaleRepository(<span style="color: rgb(43, 145, 175);">ISqlMapper</span> mapper)<br />       {<br />           <span style="color: rgb(0, 0, 255);">this</span>.mapper = mapper;<br />       }<br /><br />       <span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">bool</span> CreateSale(<span style="color: rgb(43, 145, 175);">ISale</span> sale)<br />       {<br />           mapper.Insert(<span style="color: rgb(163, 21, 21);">"InsertSaleHeader"</span>, sale);<br />           LastSaleId = sale.SaleNumber;<br />           <span style="color: rgb(0, 0, 255);">return</span> <span style="color: rgb(0, 0, 255);">true</span>;<br />       }<br /><br />       <span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">int</span> LastSaleId<br />       {<br />           <span style="color: rgb(0, 0, 255);">get</span>;<br />           <span style="color: rgb(0, 0, 255);">private</span> <span style="color: rgb(0, 0, 255);">set</span>;<br />       }</pre><br /><p>As you can see the only actual work that happens is in the CreateSale() method where the IBatis Insert() method is called, passing in the object to be saved (note that I’m only saving the sale header here – we could extend this to save the sale lines easily enough).<br /></p><p>And that’s it for the code.  Nothing too complex at all.  The rest of the work is done through the config files that IBatis loads during the Mapper.Instance() method call in the unit test.  When it's initialised iBATIS loads up the SqlMap.config file and then processes it any other config files that are reference by it to create the mapping behaviours it needs to know.<br /></p><p>The IBatis SqlMap.config file I used is shown here:</p><pre class="codeblock"><span style="color: rgb(0, 0, 255);">&lt;?</span><span style="color: rgb(163, 21, 21);">xml</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">version</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">1.0</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">encoding</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">utf-8</span>"<span style="color: rgb(0, 0, 255);"> ?&gt;<br />&lt;</span><span style="color: rgb(163, 21, 21);">sqlMapConfig</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">xmlns</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">http://ibatis.apache.org/dataMapper</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">xmlns:xsi</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">http://www.w3.org/2001/XMLSchema-instance</span>"<span style="color: rgb(0, 0, 255);"> &gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">settings</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">setting</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">useStatementNamespaces</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">false</span>"<span style="color: rgb(0, 0, 255);">/&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">settings</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">providers</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">embedded</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">providers.config, SalesIntegrationTests</span>"<span style="color: rgb(0, 0, 255);"> /&gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">database</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">provider</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">name</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">sqlServer2.0</span>"<span style="color: rgb(0, 0, 255);">/&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">dataSource</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">name</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SalesData</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">connectionString</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">Data Source=.;Initial Catalog=SalesDatabase;Integrated Security=True</span>"<span style="color: rgb(0, 0, 255);">/&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">database</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">sqlMaps</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">sqlMap</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">embedded</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">ibatis.SalesMap.xml, SalesDAL</span>"<span style="color: rgb(0, 0, 255);">/&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">sqlMaps</span><span style="color: rgb(0, 0, 255);">&gt;<br />&lt;/</span><span style="color: rgb(163, 21, 21);">sqlMapConfig</span><span style="color: rgb(0, 0, 255);">&gt;</span></pre><br /><p>And finally the SalesMap.xml file is as follows:</p><pre class="codeblock"><span style="color: rgb(0, 0, 255);">&lt;?</span><span style="color: rgb(163, 21, 21);">xml</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">version</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">1.0</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">encoding</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">UTF-8</span>"<span style="color: rgb(0, 0, 255);"> ?&gt;<br />&lt;</span><span style="color: rgb(163, 21, 21);">sqlMap</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">namespace</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SalesDAL</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">xmlns</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">http://ibatis.apache.org/mapping</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">xmlns:xsi</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">http://www.w3.org/2001/XMLSchema-instance</span>"<span style="color: rgb(0, 0, 255);"> &gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">alias</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">typeAlias</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">alias</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SaleHeader</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">type</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SalesInterfaces.ISale, SalesInterfaces</span>"<span style="color: rgb(0, 0, 255);"> /&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">alias</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">statements</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">procedure</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">id</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">InsertSaleHeader</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">parameterMap</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">InsertSaleHeader-Params</span>"<span style="color: rgb(0, 0, 255);">&gt;<br /></span>            dbo.InsertSaleHeader<br /><span style="color: rgb(0, 0, 255);">        &lt;/</span><span style="color: rgb(163, 21, 21);">procedure</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">statements</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;</span><span style="color: rgb(163, 21, 21);">parameterMaps</span><span style="color: rgb(0, 0, 255);">&gt;<br />       &lt;</span><span style="color: rgb(163, 21, 21);">parameterMap</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">id</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">InsertSaleHeader-Params</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">class</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SaleHeader</span>"<span style="color: rgb(0, 0, 255);">&gt;<br />           &lt;</span><span style="color: rgb(163, 21, 21);">parameter</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">property</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">Tax</span>"<span style="color: rgb(0, 0, 255);"> /&gt;<br />           &lt;</span><span style="color: rgb(163, 21, 21);">parameter</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">property</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">TotalValue</span>"<span style="color: rgb(0, 0, 255);"> /&gt;<br />           &lt;</span><span style="color: rgb(163, 21, 21);">parameter</span><span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">property</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SaleNumber</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">direction</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">Output</span>"<span style="color: rgb(0, 0, 255);"> </span><span style="color: rgb(255, 0, 0);">column</span><span style="color: rgb(0, 0, 255);">=</span>"<span style="color: rgb(0, 0, 255);">SaleNumber</span>"<span style="color: rgb(0, 0, 255);"> /&gt;<br />       &lt;/</span><span style="color: rgb(163, 21, 21);">parameterMap</span><span style="color: rgb(0, 0, 255);">&gt;<br />   &lt;/</span><span style="color: rgb(163, 21, 21);">parameterMaps</span><span style="color: rgb(0, 0, 255);">&gt;<br />&lt;/</span><span style="color: rgb(163, 21, 21);">sqlMap</span><span style="color: rgb(0, 0, 255);">&gt;<br /></span><br /></pre><br /><p>  </p><p>I won't go into all the details of the configuration, but as you can see it's not onerous in any way.  In fact I found that overall iBATIS it’s a lot simpler to use than NHibernate for this type of operation and it's much easier and faster using it than doing the alternative and writing ADO.NET by hand.<br /></p><p>Oh, I should also mention that there is a Castle Windsor facility that loads iBatis up for you so you don’t have to maintain dependencies throughout your application.<br /></p><p>So when is using IBatis a good choice?  I'll let the IBatis team say it in their own words (taken from the documentation):<br /></p><blockquote><em>So, how do you decide whether to OR/M or to DataMap? As always, the best advice is to implement a representative part of your project using either approach, and then decide. But, in general, OR/M is a good thing when you</em><br /><ol compact="compact"><li><em>Have complete control over your database implementation</em></li><li><em>Do not have a Database Administrator or SQL guru on the team</em></li><li><em>Need to model the problem domain outside the database as an object graph.</em></li></ol><em>Likewise, the best time to use a Data Mapper, like iBATIS, is when:</em><br /><ol compact="compact"><li><em>You do not have complete control over the database implementation, or want to continue to access a legacy database as it is being refactored.</em></li><li><em>You have database administrators or SQL gurus on the team.</em></li><li><em>The database is being used to model the problem domain, and the application's primary role is to help the client use the database model.</em></li></ol><em>In the end, you have to decide what's best for your project. If a OR/M tool works better for you, that's great! If your next project has different needs, then we hope you give iBATIS another look. If iBATIS works for you now: Excellent!</em></blockquote>
---
layout: post
title: Performance Differences with the new SQL 2008 Insert Statement
date: '2007-08-20T14:16:00.001+10:00'
author: Richard Banks
tags:
- database
- readify
modified_time: '2007-08-21T08:52:00.160+10:00'
thumbnail: http://bp1.blogger.com/_5dD_rBQSs2o/RskWGnaguSI/AAAAAAAAADw/ExD5-4Owx5g/s72-c/executionplan2.png
blogger_id: tag:blogger.com,1999:blog-13321238.post-5804010797196188099
blogger_orig_url: http://www.richard-banks.org/2007/08/performance-differences-with-new-sql.html
---

I had a question from Sanchet on the <a href="http://richardsbraindump.blogspot.com/2007/07/what-new-in-sql-2008-katmai.html">new insert statement syntax in SQL 2008</a> and the relative performance difference between the two methods.<br /><br />For instance if we take a look at the following statements, they both have the same net result with the difference that the first statement is a single statement using the multiple row insert syntax, while the second is the way things are typically done.<br /><br /><pre class="codeblock">insert into humanresources.employeepayhistory<br />values<br />(1, getdate(), 100, 1, getdate()),<br />(2, getdate(), 100, 1, getdate()),<br />(3, getdate(), 100, 1, getdate()),<br />(4, getdate(), 100, 1, getdate())</pre><br /><pre class="codeblock">insert into humanresources.employeepayhistory values (1, getdate(), 100, 1, getdate())<br />insert into humanresources.employeepayhistory values (2, getdate(), 100, 1, getdate())<br />insert into humanresources.employeepayhistory values (3, getdate(), 100, 1, getdate())<br />insert into humanresources.employeepayhistory values (4, getdate(), 100, 1, getdate())</pre><br />Having a look at the difference between the two is very interesting. I ran both queries on the <a href="http://www.codeplex.com/MSFTDBProdSamples">sample AdventureWorks database</a> (inside a begin/rollback transaction so I could work from a consistent base point) using SQL 2008 CTP4 (July 2007)and looked at the execution plans and the client statistics to see what the difference is on something simple like this.<br /><br /><h4>Execution plans:</h4><br />The two pictures below show the differences between the execution plans. As you can see the individual inserts are executed singly and has a TRIVIAL optimisation level applied. The cost of each statement is 0.0132898, so the 4 statements will have a total cost of 0.0531592<br /><br />The multi-row insert version is quite different. It has an optimisation level of FULL and the whole statement has a cost of 0.0187608. A cost reduction of 0.0343984 (or about 65%!). That's seriously significant when we're talking about such a small amount of data.<br />You can also see that there is a lot more work being done earlier in the execution plan (apologies for the cramped visuals) which is where the real savings are occurring.<br /><br />Here's the visual difference between the two plans (click for a larger view):<br /><br />[Multi-row Insert]<br /><a href="http://bp1.blogger.com/_5dD_rBQSs2o/RskWGnaguSI/AAAAAAAAADw/ExD5-4Owx5g/s1600-h/executionplan2.png"><img id="BLOGGER_PHOTO_ID_5100632355889002786" style="CURSOR: hand" alt="" src="http://bp1.blogger.com/_5dD_rBQSs2o/RskWGnaguSI/AAAAAAAAADw/ExD5-4Owx5g/s320/executionplan2.png" border="0" /></a><br />[Multiple Inserts]<br /><a href="http://bp3.blogger.com/_5dD_rBQSs2o/RskWCHaguRI/AAAAAAAAADo/-kuxjx8BOxY/s1600-h/executionplan1.png"><img id="BLOGGER_PHOTO_ID_5100632278579591442" style="CURSOR: hand" alt="" src="http://bp3.blogger.com/_5dD_rBQSs2o/RskWCHaguRI/AAAAAAAAADo/-kuxjx8BOxY/s320/executionplan1.png" border="0" /></a><br /><br /><h4>Client Statistics:</h4><br />The client statistics are also very interesting. The single statement (multi-row inserts) has far fewer selects and inserts and this is obviously where the major savings occur, though the overall time saving of 40% was also a surprise.<br /><br /><table cellspacing="0" cellpadding="2" width="508" border="1" unselectable="on"><tbody><tr><td valign="top" width="245">Run</td><td valign="top" width="127">Single Statement</td><td valign="top" width="134">Separate Statements</td></tr><tr><td valign="top" width="244">Query Profile Statistics</td><td valign="top" width="128"></td><td valign="top" width="134"></td></tr><tr><td valign="top" width="243">Number of INSERT, DELETE and UPDATE statements</td><td valign="top" width="129">2</td><td valign="top" width="134">8</td></tr><tr><td valign="top" width="243">Rows affected by INSERT, DELETE, or UPDATE statements</td><td valign="top" width="129">4</td><td valign="top" width="134">4</td></tr><tr><td valign="top" width="243">Number of SELECT statements</td><td valign="top" width="129">1</td><td valign="top" width="134">4</td></tr><tr><td valign="top" width="243">Rows returned by SELECT statements </td><td valign="top" width="129">1</td><td valign="top" width="134">4</td></tr><tr><td valign="top" width="243">Number of transactions</td><td valign="top" width="129">1</td><td valign="top" width="134">1</td></tr><tr><td valign="top" width="243">Network Statistics</td><td valign="top" width="129"></td><td valign="top" width="134"></td></tr><tr><td valign="top" width="243">Number of server roundtrips</td><td valign="top" width="129">3</td><td valign="top" width="134">3</td></tr><tr><td valign="top" width="243">TDS packets sent from client</td><td valign="top" width="129">3</td><td valign="top" width="134">3</td></tr><tr><td valign="top" width="243">TDS packets received from server</td><td valign="top" width="129">11</td><td valign="top" width="134">24</td></tr><tr><td valign="top" width="243">Bytes sent from client</td><td valign="top" width="129">626</td><td valign="top" width="134">934</td></tr><tr><td valign="top" width="243">Bytes received from server </td><td valign="top" width="129">33338</td><td valign="top" width="134">88924</td></tr><tr><td valign="top" width="243">Time Statistics</td><td valign="top" width="129"></td><td valign="top" width="134"></td></tr><tr><td valign="top" width="243">Client processing time</td><td valign="top" width="129">30</td><td valign="top" width="134">50</td></tr><tr><td valign="top" width="243">Total execution time</td><td valign="top" width="129">30</td><td valign="top" width="134">50</td></tr><tr><td valign="top" width="243">Wait time on server replies</td><td valign="top" width="131">0</td><td valign="top" width="134">0</td></tr></tbody></table><br />The moral: When inserting multiple rows into the database use the new multi-row insert syntax rather than the traditional method of having multiple insert statements.<br /><br />[Note: CTP performance is always a work in progress and performance information here will likely be improved upon in the final RTM release]
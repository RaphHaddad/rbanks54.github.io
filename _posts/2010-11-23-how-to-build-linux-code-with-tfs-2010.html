---
layout: post
title: How to Build Linux Code with TFS 2010 Team Build
date: '2010-11-23T19:34:00.001+11:00'
author: Richard Banks
tags:
- how to
- TFS
modified_time: '2010-11-23T19:34:55.240+11:00'
thumbnail: http://lh5.ggpht.com/_5dD_rBQSs2o/TOt8kwNq8tI/AAAAAAAAA6o/UZsz1zez6Pw/s72-c/image_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-13321238.post-3689721453034644188
blogger_orig_url: http://www.richard-banks.org/2010/11/how-to-build-linux-code-with-tfs-2010.html
---

<p>With the release of Team Foundation Server 2010 and Team Explorer Everywhere Microsoft extended the reach of TFS beyond just the Microsoft ecosystem and provided a way for people doing Linux and Mac development to use TFS to meet their Application Lifecycle Management (ALM) needs.</p>  <p>Whilst TFS works great for source control and work items for Linux development it doesn’t include a Linux specific build agent so many people think it can’t be done.&#160; But that’s not quite true. And yes, before people point out the obvious, there are a number of excellent Linux specific build engines that can do automated builds from TFS source by calling the tf command line, but they don’t integrate into TFS in anywhere near the same way that Team Build does which is why Team Build a desirable option for many places.</p>  <p>Anyway, back to the issue at hand, thanks to tools like PuTTY we can do remote shell calls to Linux boxes as part of the build process, and you we can also copy files to and from the Linux box as part of the same process which gives us the ability to compile on Linux and still get the compiled binaries placed in the drop location as per normal windows builds.</p>  <p>For example I have a customer at the moment who is moving their Progress source code (yuck!) out of Roundtable and into TFS, and as part of that transition we’re moving the build from a custom set of shell scripts into Team Build.&#160; Without going into the specifics of their particular needs, let’s have a quick look at some of the key ingredients needed to get Team Build successfully executing commands on a remote Linux server.</p>  <h3>Install and Configure PuTTY on the Windows Build Agent</h3>  <p>As mentioned before we’re going to use some of the PuTTY tools to connect to the remote Linux box.&#160; If you haven’t already done so, <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank">go grab the Windows PuTTY installer</a> from the download page and install it on your build server.</p>  <p>Now we need to configure PuTTY so it knows how to connect to the remote server.&#160; We’re going to use SSH to do this, and since we don’t want to store passwords in our build scripts we want to <a href="http://the.earth.li/~sgtatham/putty/0.58/htmldoc/Chapter8.html" target="_blank">use a public key for authentication</a>.</p>  <p>Login to your build server using the build service account.&#160; Note: This is important! If you don’t do this then you will likely have issues the first time you run a build as ssh will prompt the first time you use a public key for authentication and the build will hang waiting for a response.</p>  <p>Now open a command prompt, go to the install folder for PuTTY and run <strong><em>puttygen.exe</em></strong>.&#160; A dialog will appear.</p>  <p><a href="http://lh6.ggpht.com/_5dD_rBQSs2o/TOt8jXDpwqI/AAAAAAAAA6k/7BBN4G2hSH4/s1600-h/image%5B2%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_5dD_rBQSs2o/TOt8kwNq8tI/AAAAAAAAA6o/UZsz1zez6Pw/image_thumb.png?imgmax=800" width="244" height="236" /></a></p>  <p>Click Generate and move the mouse around a little as requested (such fun!) until you get a key generated.</p>  <p><a href="http://lh5.ggpht.com/_5dD_rBQSs2o/TOt8mXywFMI/AAAAAAAAA6s/Fe0RaJF-u7c/s1600-h/image%5B5%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_5dD_rBQSs2o/TOt8ogMiRfI/AAAAAAAAA6w/N9kXR-TBa_o/image_thumb%5B1%5D.png?imgmax=800" width="244" height="236" /></a></p>  <p>Note that we’re intentionally leaving the passphrase blank so that we don’t get prompted for a password during the build process.&#160; This of course means there is a potential security hole if someone attacks the windows build agent machine, so make sure that the account you will log in to on the Linux box is not a privileged account.&#160; Save both your public and private keys.</p>    <p>Next, login to your Linux box and open the <em><strong>$HOME/.ssh/authorized_keys</strong></em> file in vim and paste in the public key as a new entry in that file, then save the changes, close the file and log off.</p>  <p>Now to test it and get through that first configuration prompt.</p>  <p>From your windows command prompt run plink to do a listing of your home directory on the Linux box.&#160; For example:</p>  <p><em>plink –batch –ssh –i privateKey.ppk </em><a href="mailto:linuxBuildAccount@linuxServer"><em>linuxBuildAccount@linuxServer</em></a><em> “ls –l”</em></p>  <p>When prompted to store the key answer with a “y&quot;es.&#160; Once that’s been done once we won’t get asked again when we run automatic builds.</p>  <p>Assuming this works, and you see something coming back then we’re right to move on.</p>  <h3>Customising TFS Team Build to Build on Linux</h3>  <p>From here it’s pretty simple and works much the same as the <a href="http://www.richard-banks.org/2010/08/how-to-build-vb6-apps-with-tfs-team.html" target="_blank">customisation for VB6 builds</a> I’ve posted about in the past.&#160; This won’t be a complete blow-by-blow on how to do it – just enough information to cover the important parts you need to know.</p>  <p>For all the remote Linux interactions we’re going to rely on the InvokeProcess workflow activity to make the calls we need for our build process.</p>  <p>As a note, I usually take the existing Default Process template and gut it – removing most of the activities from after the workspace has synced (i.e. the get latest section) and the code has been pulled down to the build agent and use that as a starting point for building up the Linux build process.</p>  <p>Regardless, once the code has been pulled down into the build agent’s workspace we have two choices for making the source available to Linux.&#160; We could define a network share that points to the build agent’s $(Sources) folder and get Linux to build the sources using a UNC path (via samba), or alternatively we could use PuTTY’s pscp command to copy the sources to the Linux machine for local compilation and copy the compiled output back when the build completes.&#160; You should do whatever you are more comfortable with, and since both have pros and cons it will be a matter of how your Linux build works that dictates the best approach.</p>  <p>For this example let’s do a copy of code onto the Linux box and then call the compile.</p>  <p>Begin by dragging an InvokeProcess activity into your build process workflow at an appropriate point:</p>  <p><a href="http://lh3.ggpht.com/_5dD_rBQSs2o/TOt8py98s3I/AAAAAAAAA60/nitTy5q-gNA/s1600-h/image%5B13%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/_5dD_rBQSs2o/TOt8rPPHKNI/AAAAAAAAA64/4AwoE-utTSo/image_thumb%5B5%5D.png?imgmax=800" width="244" height="229" /></a></p>  <p>and set the properties of it as follows </p>  <p><strong>FileName:</strong> <em>&quot;&quot;&quot;&quot; &amp; Environment.GetFolderPath(Environment.SpecialFolder.ProgramFilesX86) &amp; &quot;\PuTTY\pscp.exe&quot; &amp; &quot;&quot;&quot;&quot;     <br /></em><strong>Arguments:</strong> <em>&quot;-batch -scp -i &quot;&quot;&quot;Path\to\\privateKey.ppk&quot;&quot; “ &amp; SourcesDirectory &amp;&#160; “ linuxBuildAccount@linuxServer:/build/sources&quot;&quot;&quot;</em></p>  <p>Don’t forget to check for error conditions when the task completes.</p>  <p>Next drag another InvokeProcess activity into your workflow and this time use plink instead of pscp and call the command or script you need to do the compile. The following activity properties show an example:</p>  <p><strong>FileName:</strong> <em>&quot;&quot;&quot;&quot; &amp; Environment.GetFolderPath(Environment.SpecialFolder.ProgramFilesX86) &amp; &quot;\PuTTY\plink.exe&quot; &amp; &quot;&quot;&quot;&quot;     <br /></em><strong>Arguments:</strong> <em>&quot;-batch -ssh -i &quot;&quot;Path\to\privateKey.ppk&quot;&quot;&#160; </em><a href="mailto:linuxBuildAccount@linuxServer"><em>linuxBuildAccount@linuxServer</em></a><em> &quot;&quot;&lt;command to run – e.g. make all&gt;&quot;&quot;&quot;</em></p>  <p>Again, don’t forget to check for errors.</p>  <p>Finally when the build is done use another InvokeProcess activity to call pscp as shown above and copy any compiled output to the drop location.&#160; For reference the drop location folder can be found using the <a href="http://msdn.microsoft.com/en-us/library/microsoft.teamfoundation.build.server.builddetail.droplocation.aspx" target="_blank">BuildDetail.DropLocation</a> property.</p>  <p>&#160;</p>  <p>Hopefully this is enough to get you on your way to building your Linux applications via TFS 2010’s Team Build.&#160; Good luck!</p>  